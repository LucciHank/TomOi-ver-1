{% load static %}
{% load custom_filters %}
{% load cart_tags %}

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="author" content="Đỗ Hoàng Anh">
  <meta name="keywords" content="netflix, prime, disney, hbo, hulu, apple tv, amazon prime, disney plus, hbo max, apple tv+, amazon prime video, disney+,
  spotify,pornhub,ai, premium, phần mềm bản quyền, phần mềm miễn phí, phần mềm giải trí, phần mềm làm việc, phần mềm học tập, phần mềm game, phần mềm edit ảnh,
  phần mềm edit video, phần mềm window, phần mềm office, phần mềm google drive, phần mềm steam wallet, phần mềm diệt virus, phần mềm xbox,
  phần mềm itunes gift card,">
  <meta name="description" content="">
  <title>TomOi.vn - Phần Mềm Bản Quyền Chính Hãng | Tài Khoản Premium</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  
  <!-- Base CSS -->
  <link href="{% static 'css/style.css' %}?v=1.1" rel="stylesheet"/>
  <link href="{% static 'css/security.css' %}?v=1.1" rel="stylesheet"/>
  <link href="{% static 'store/css/home.css' %}?v=1.1" rel="stylesheet"/>
  

  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  
  <!-- Google Translate -->
  <script>
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'vi',
        includedLanguages: 'en,vi,zh-CN,ko,ja',
        autoDisplay: false,
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  
  <!-- Allow child templates to add their own CSS -->
  {% block page_css %}{% endblock %}

  <!-- SEO Meta Tags -->
  <meta name="description" content="TomOi.vn - Nền tảng cung cấp phần mềm bản quyền, tài khoản premium Netflix, Spotify, Disney+, HBO, Office 365 uy tín hàng đầu Việt Nam. Thanh toán an toàn, kích hoạt tức thì, hỗ trợ 24/7.">
  <meta name="keywords" content="phần mềm bản quyền, tài khoản premium, netflix việt nam, spotify premium, disney plus, hbo go, microsoft office, windows bản quyền, phần mềm diệt virus, phần mềm làm việc, phần mềm học tập, phần mềm giải trí, steam wallet, google drive, apple id, pornhub premium, tài khoản streaming, phần mềm chỉnh sửa ảnh, phần mềm edit video">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="TomOi.vn - Phần Mềm Bản Quyền Chính Hãng | Tài Khoản Premium">
  <meta property="og:description" content="Nền tảng cung cấp phần mềm bản quyền và tài khoản premium uy tín hàng đầu Việt Nam">
  <meta property="og:image" content="{% static 'images/og-image.jpg' %}">
  <meta property="og:url" content="https://tomoi.vn">
  
  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="TomOi.vn - Phần Mềm Bản Quyền Chính Hãng">
  
  <!-- Additional SEO Meta Tags -->
  <meta name="robots" content="index, follow">
  <meta name="author" content="TomOi.vn">
  <meta name="language" content="Vietnamese">
  <link rel="canonical" href="https://tomoi.vn{{ request.path }}">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Thêm favicon -->
  <link rel="shortcut icon" type="image/png" href="{% static 'images/favicon.ico' %}"/>

  <!-- Thêm CSS cho phần OTP -->
  <style>
    .otp-inputs {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
        width: 100%;
    }

    .otp-input {
        width: calc((100% - 50px) / 6); /* 50px là tổng gap (5 * 10px) */
        height: 50px;
        text-align: center;
        font-size: 24px;
        border-radius: 8px;
        border: 1px solid #ced4da;
    }

    .otp-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
    }

    .resend-section {
        text-align: center;
        margin-top: 20px;
    }

    #resendOtpBtn {
        color: #0d6efd;
        text-decoration: none;
        border: none;
        background: none;
        padding: 0;
    }

    #resendOtpBtn:disabled {
        color: #6c757d;
        cursor: not-allowed;
    }

    .resend-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    #resendOtpBtn {
        color: #0d6efd;
        text-decoration: none;
        border: none;
        background: none;
        padding: 0;
        margin: 0;
    }

    .password-requirements {
        font-size: 0.85rem;
        margin-top: 10px;
    }

    .password-requirements p {
        color: #666;
    }

    .password-requirements ul {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

    .password-requirements li {
        color: #666;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .password-requirements li::before {
        content: '';
        display: inline-block;
        width: 16px;
        height: 16px;
        background-size: contain;
        background-repeat: no-repeat;
    }

    .password-requirements li.invalid::before {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc3545'%3E%3Cpath d='M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z'/%3E%3C/svg%3E");
    }

    .password-requirements li.valid::before {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2328a745'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/%3E%3C/svg%3E");
    }

    .toggle-password {
        cursor: pointer;
    }

    .toggle-password:focus {
        box-shadow: none;
    }

    /* Thêm class register-requirements để phân biệt */
    .register-modal .password-requirements {
        font-size: 0.85rem;
        margin-top: 10px;
        margin-bottom: 0 !important;
    }

    .register-modal .password-requirements p {
        color: #666;
    }

    .register-modal .password-requirements ul {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

    .register-modal .password-requirements li {
        color: #666;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .register-modal .password-requirements li::before {
        content: '';
        display: inline-block;
        width: 16px;
        height: 16px;
        background-size: contain;
        background-repeat: no-repeat;
    }

    .register-modal .password-requirements li.invalid::before {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc3545'%3E%3Cpath d='M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z'/%3E%3C/svg%3E");
    }

    .register-modal .password-requirements li.valid::before {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2328a745'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/%3E%3C/svg%3E");
    }
  </style>
</head>
<body data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
  <!-- Google Translate Element -->
  <div id="google_translate_element" style="position: fixed; top: 10px; right: 10px; z-index: 9999;"></div>

  {% csrf_token %}

<nav class="navbar navbar-expand-lg">
      <!-- Logo -->
      <a class="navbar-brand" href="{% url 'store:home' %}">
          <img alt="Logo" src="https://placehold.co/40x40"/>
      </a>
      
        <!-- Menu button -->
        <div class="nav-menu-item">
          <button class="category-button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-list"></i>
            Danh mục
          </button>
          <ul class="dropdown-menu category-list">
            {% for category in categories %}
            <li>
                <a class="dropdown-item" href="{% url 'store:category_detail' category.slug %}">
                    <i class="{{ category.icon_class|default:'fas fa-folder' }}"></i>
                    {{ category.name }}
                </a>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

        <!-- Search bar -->
        <div class="search-bar">
            <input placeholder="Tìm kiếm sản phẩm..." type="text"/>
            <button type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <ul class="navbar-nav ms-auto">

            <!-- User Icon -->
            <li class="nav-item">
                <a class="nav-link user-icon" href="#">
                    {% if user.is_authenticated %}
                        {% if user.avatar %}
                            <img src="{{ user.avatar.url }}" alt="Avatar">
                        {% else %}
                            <img src="{% static 'images/default-avatar.png' %}" alt="Default Avatar">
                        {% endif %}
                    {% else %}
                        <i class="fa fa-user"></i>
                    {% endif %}
                </a>
                <div class="dropdown-content">
                    {% if user.is_authenticated %}
                        <p class="username">
                            <i class="fas fa-user"></i>
                            <span>{{ user.username }}</span>
                        </p>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-wallet"></i> Số dư: <b>{{ user.balance|format_balance }}</b>
                        </a>
                        <a href="{% url 'accounts:user_info' %}" class="dropdown-item">
                            <i class="fas fa-user-cog"></i> Thông tin tài khoản
                        </a>
                        <a href="{% url 'accounts:security' %}" class="dropdown-item">
                            <i class="fas fa-shield-alt"></i> Bảo mật
                        </a>
                        <a href="/store/user-info/order-history/" class="dropdown-item">
                            <i class="fas fa-history"></i> Sản phẩm đã mua
                        </a>
                        <a href="{% url 'accounts:wishlist' %}" class="dropdown-item">
                            <i class="fas fa-heart"></i> Sản phẩm yêu thích
                        </a>
                        <a href="{% url 'accounts:logout' %}" class="dropdown-item">
                            <i class="fas fa-sign-out-alt"></i> Đăng xuất
                        </a>
                    {% else %}
                        <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#authModal">
                            <i class="fas fa-sign-in-alt"></i> Đăng nhập / Đăng ký
                        </a>
                    {% endif %}
                </div>
            </li>

            <!-- Cart -->
            <li class="nav-item cart-wrapper">
                <button class="cart-button">
                    <i class="fas fa-shopping-cart"></i>
                    Giỏ hàng
                    <span class="cart-count-badge" style="display: none;">0</span>
                </button>
                <div class="cart-dropdown-content">
                    <div class="cart-items">
                        {% for item in cart_items %}
                        <div class="cart-item" data-id="{{ item.id }}" data-stock="{{ item.stock }}">
                            <div class="item-controls">
                                <div class="quantity-controls">
                                    <button class="quantity-btn minus" data-id="{{ item.id }}">-</button>
                                    <input type="number" class="quantity-input" value="{{ item.quantity }}" min="1" max="{{ item.stock }}" readonly>
                                    <button class="quantity-btn plus" data-id="{{ item.id }}">+</button>
                                </div>
                                <button class="remove-btn" data-id="{{ item.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="empty-cart" style="display: none;">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Bạn chưa có sản phẩm nào trong giỏ hàng</p>
                    </div>
                    <div class="cart-total">
                        <span>Tổng cộng:</span>
                        <span class="total-amount">0đ</span>
                    </div>
                    <div class="cart-footer">
                        <a href="{% url 'store:cart' %}" class="btn btn-primary">Xem giỏ hàng</a>
                        <a href="#" class="btn btn-checkout">Thanh toán ngay</a>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</nav>

<!-- Modal Đăng Nhập -->
<div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <!-- Logo trên cùng -->
        <img src="https://placehold.co/50x50" alt="Logo Shop" class="me-auto">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h5 class="text-center">Đăng Nhập</h5>
        <form id="loginForm" method="post" action="{% url 'accounts:login' %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="loginUsername" class="form-label">Tên đăng nhập / Email</label>
            <input type="text" class="form-control" id="loginUsername" name="username" required>
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Mật khẩu</label>
            <div class="input-group">
            <input type="password" class="form-control" id="loginPassword" name="password" required>
              <button class="btn btn-outline-secondary toggle-password" type="button">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="rememberMe" name="remember_me">
              <label class="form-check-label" for="rememberMe">Ghi nhớ đăng nhập</label>
            </div>
            <a href="#" id="forgotPasswordLink" class="text-decoration-none" data-bs-toggle="modal" data-bs-dismiss="modal" data-bs-target="#forgotPasswordModal">
              Quên mật khẩu?
            </a>
          </div>
          <button type="submit" class="btn btn-primary w-100">Đăng nhập</button>
        </form>
        <div class="text-center my-3">
          <span>HOẶC</span>
        </div>
        <div class="d-grid gap-2">
          <a href="{% url 'social:begin' 'google-oauth2' %}" class="btn btn-danger">
            <i class="fab fa-google me-2"></i>Đăng nhập với Google
        </a>
        </div>
        <div class="text-center mt-3">
          <span>Bạn chưa có tài khoản? <a href="#" id="registerLink" class="text-decoration-none" data-bs-toggle="modal" data-bs-dismiss="modal" data-bs-target="#registerModal">Đăng ký ngay</a></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Quên Mật Khẩu -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true" >
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <img src="https://placehold.co/50x50" alt="Logo Shop" class="me-auto">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h5 class="text-center">Quên Mật Khẩu</h5>
        <form id="forgotPasswordForm" method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label for="forgotEmail" class="form-label">Email</label>
            <div class="input-group">
              <input type="email" class="form-control" id="forgotEmail" name="email" required>
              <button class="btn btn-outline-secondary" type="button" id="editEmailBtn">
                <i class="fas fa-pencil-alt"></i>
              </button>
            </div>
          </div>
          <button type="button" class="btn btn-primary w-100" id="sendOtpBtn">Gửi mã xác nhận</button>
        </form>
        <div class="text-center mt-3">
          <a href="#" class="text-decoration-none" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#authModal">
            Quay lại đăng nhập
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Verify OTP -->
<div class="modal fade" id="verifyOtpModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <img src="https://placehold.co/50x50" alt="Logo Shop" class="me-auto">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h5 class="text-center">Xác minh OTP</h5>
                <p class="text-center mb-3">
                    Mã xác nhận đã được gửi đến email: 
                    <span id="displayEmail" class="fw-bold"></span>
                    <a href="#" id="editEmailLink" class="ms-2 text-decoration-none">
                        <i class="fas fa-pencil-alt"></i> Chỉnh sửa
                    </a>
                </p>
                <form id="verifyOtpForm">
                    {% csrf_token %}
                    <div class="otp-inputs">
                        {% for i in '123456' %}
                            <input type="text" maxlength="1" class="form-control otp-input" required>
                        {% endfor %}
                        </div>
                    <button type="button" class="btn btn-primary w-100 mb-3" id="verifyOtpBtn">Xác minh</button>
                    <div class="text-center">
                        <div class="resend-wrapper">
                            <span>Bạn chưa nhận được mã?</span>
                        <button type="button" id="resendOtpBtn" class="btn btn-link p-0">Gửi lại</button>
                </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Thêm script để đếm ngược -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let countdownInterval;
    const resendBtn = document.getElementById('resendOtpBtn');

    function startCountdown() {
        let countdown = 30;
      resendBtn.disabled = true;
        resendBtn.textContent = `Gửi lại (${countdown}s)`;
        
        // Clear any existing interval
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
                resendBtn.textContent = `Gửi lại (${countdown}s)`;
                resendBtn.disabled = true;  // Đảm bảo nút luôn bị disable trong quá trình đếm ngược
        } else {
                clearInterval(countdownInterval);
          resendBtn.disabled = false;
          resendBtn.textContent = 'Gửi lại';
        }
      }, 1000);
    }

    // Xử lý nút Gửi lại OTP
    resendBtn.addEventListener('click', function() {
        if (this.disabled) return;  // Ngăn chặn click khi đang disable

        const email = document.getElementById('displayEmail').textContent;
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        this.disabled = true;
        this.textContent = 'Đang gửi...';

        fetch('{% url "accounts:resend_otp" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: `email=${encodeURIComponent(email)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                startCountdown();  // Bắt đầu đếm ngược mới
            } else {
                Swal.fire({
                    icon: 'error',
                    text: data.message,
                    showConfirmButton: true
                });
                this.disabled = false;
                this.textContent = 'Gửi lại';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            this.disabled = false;
            this.textContent = 'Gửi lại';
        });
    });

    // Khởi động đếm ngược khi modal mở
    const verifyOtpModal = document.getElementById('verifyOtpModal');
    verifyOtpModal.addEventListener('shown.bs.modal', function() {
      startCountdown();
    });

    // Clear interval khi modal đóng
    verifyOtpModal.addEventListener('hidden.bs.modal', function() {
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
    });
  });
</script>

<!-- Modal Đặt Password mới -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <img src="https://placehold.co/50x50" alt="Logo Shop" class="me-auto">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h5 class="text-center">Đặt Lại Mật Khẩu</h5>
        <form id="resetPasswordForm" method="post">
          {% csrf_token %}
          <div class="mb-3">
            <label for="newPassword" class="form-label">Mật khẩu mới</label>
            <input type="password" class="form-control" id="newPassword" name="new_password" required>
          </div>
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Xác nhận mật khẩu</label>
            <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Đặt lại mật khẩu</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Register -->
<div class="modal fade register-modal" id="registerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Đăng ký</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="registerForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Tên đăng nhập</label>
            <input type="text" name="username" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Mật khẩu</label>
            <div class="input-group">
              <input type="password" name="password" id="registerPassword" class="form-control" required>
              <button class="btn btn-outline-secondary toggle-password" type="button">
                <i class="fas fa-eye"></i>
              </button>
          </div>
            <div class="password-requirements small text-muted mt-1">
              <p>Mật khẩu phải đáp ứng các yêu cầu sau:</p>
              <ul>
                  <li id="length-check" class="invalid">Có ít nhất 8 ký tự</li>
                  <li id="number-check" class="invalid">Không được sử dụng toàn số</li>
                  <li id="common-check" class="invalid">Không được sử dụng mật khẩu quá phổ biến</li>
                  <li id="personal-check" class="invalid">Không được giống với Username</li>
              </ul>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Nhập lại mật khẩu</label>
            <div class="input-group">
              <input type="password" name="confirm_password" id="confirmPassword" class="form-control" required>
              <button class="btn btn-outline-secondary toggle-password" type="button">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100" id="registerBtn">Đăng ký</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Thêm modal yêu cầu đăng nhập -->
<div class="modal fade" id="loginRequiredModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Yêu cầu đăng nhập</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Bạn cần đăng nhập hoặc đăng ký để thêm sản phẩm vào giỏ hàng.</p>
        <div class="d-grid gap-2">
          <button class="btn btn-primary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#authModal">
            <i class="fas fa-sign-in-alt"></i> Đăng nhập
          </button>
          <button class="btn btn-success" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#registerModal">
            <i class="fas fa-user-plus"></i> Đăng ký
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Register Verify -->
<div class="modal fade" id="registerVerifyModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body text-center">
                <i class="fas fa-envelope-open-text fa-4x mb-4" style="color: #e50914;"></i>
                <h5>Xác thực email</h5>
                <p>Chúng tôi đã gửi email xác thực đến địa chỉ email của bạn.</p>
                <p>Vui lòng kiểm tra hộp thư (bao gồm thư rác) và nhấp vào liên kết xác thực.</p>
                <div class="mt-4">
                    <p>Không nhận được email? 
                        <a href="#" id="resendVerifyEmailBtn" class="text-primary">Gửi lại email xác thực</a>
                    </p>
                </div>
                <div class="mt-3">
                    <a href="{% url 'accounts:logout' %}" class="btn btn-secondary">Đăng xuất</a>
                </div>
            </div>
        </div>
    </div>
</div>

  <div class="container mt-4 content">
    {% block content %}
    <!-- Nội dung trang con sẽ kế thừa và thay thế phần này -->
    {% endblock %}
  </div>

  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-md-3">
          <h2><b>TomOi.vn</b></h2>
          <div class="social-icons">
            <a href="#"><i class="fab fa-facebook"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-tiktok"></i></a>
            <a href="#"><i class="fab fa-youtube"></i></a>
          </div>
          <br>
          <h5 class="mt-3"><b>LIÊN HỆ</b></h5>
          <ul class="list-unstyled">
            <li><a href="#">Zalo</a></li>
            <li><a href="#">Email</a></li>
            <li><a href="#">Hotline</a></li>
          </ul>
        </div>

        <div class="col-md-3">
          <h5><b>GIỚI THIỆU</b></h5>
          <br>
          <ul class="list-unstyled">
            <li><a href="#">Quy định mua hàng</a></li>
            <li><a href="#">Hướng dẫn mua hàng</a></li>
            <li><a href="#">Thủ thuật &amp; Tin tức </a></li>
            <li><a href="#">Tra cứu bảo hành</a></li>
            <li><a href="#">Câu hỏi thường gặp</a></li>
            <li><a href="#">Chính sách bảo hành</a></li>
            <li><a href="#">Hình thức thanh toán</a></li>
          </ul>
        </div>
        <div class="col-md-3">
          <h5><b>CHƯƠNG TRÌNH</b></h5>
          <br>
          <ul class="list-unstyled"> 
            <li><a href="#">Đăng ký làm Cộng Tác Viên</a></li>
            <li><a href="#">Đăng ký làm Đối Tác</a></li>
            <li><a href="#">Giới thiệu bạn bè</a></li>
            <li><a href="#">Đổi Mail - Nhận tiền</a></li>
            <li><a href="#">Nhận tài khoản miễn phí</a></li>
            <li><a href="#">Tuyển dụng</a></li>
          </ul>
        </div>
        <div class="col-md-3">
          <h5><b>HỖ TRỢ THANH TOÁN</b></h5>
          <br>
          <div class="payment-icons">
            <img alt="Visa" src="https://placehold.co/50x30"/>
            <img alt="Mastercard" src="https://placehold.co/50x30"/>
            <img alt="JCB" src="https://placehold.co/50x30"/>
            <img alt="AMEX" src="https://placehold.co/50x30"/>
            <img alt="VNPay" src="https://placehold.co/50x30"/>
            <img alt="ZaloPay" src="https://placehold.co/50x30"/>
            <img alt="Napas" src="https://placehold.co/50x30"/>
            <img alt="Kredivo" src="https://placehold.co/50x30"/>
            <img alt="Momo" src="https://placehold.co/50x30"/>
            <img alt="Foxpay" src="https://placehold.co/50x30"/>
            <img alt="ViettelPay" src="https://placehold.co/50x30"/>
            <img alt="HomePayLater" src="https://placehold.co/50x30"/>
            <img alt="ApplePay" src="https://placehold.co/50x30"/>
            <img alt="SamsungPay" src="https://placehold.co/50x30"/>
            <img alt="GooglePay" src="https://placehold.co/50x30"/>
          </div>
          <h5 class="mt-3"><b>CHỨNG NHẬN</b></h5>
          <div class="certification-icons">
            <img alt="DMCA" src="https://placehold.co/100x30"/>
            <img alt="Bộ Công Thương" src="https://placehold.co/100x30"/>
            <img alt="ISO Certification" src="https://placehold.co/100x30"/>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <hr>
      <p>© Copyright 2024 <b>TomOi.vn</b> – All rights reserved.</p>
  </div>
  </footer>

  <!-- Load các thư viện JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Load base.js trước -->
<script src="{% static 'accounts/js/base.js' %}?v=1.2"></script>

<!-- Load các file JS khác sau -->
  {% block extra_js %}{% endblock %}

<!-- Thêm script này vào phần cuối của base.html, trước </body> -->
<script>
// Lấy các modal
const forgotPasswordModal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
const verifyOtpModal = new bootstrap.Modal(document.getElementById('verifyOtpModal'));
const resetPasswordModal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));

// Xử lý form quên mật khẩu
document.getElementById('sendOtpBtn').addEventListener('click', function() {
    const button = this;
    button.disabled = true;
    button.innerHTML = 'Đang xử lý...';

    const email = document.getElementById('forgotEmail').value;
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "accounts:send_otp" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
        },
        body: `email=${encodeURIComponent(email)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                text: 'Đã gửi mã xác thực đến email của bạn',
                showConfirmButton: false,
                timer: 3000
            });

            // Hiển thị email đầy đủ
            document.getElementById('displayEmail').textContent = email;

            // Đóng modal quên mật khẩu và mở modal nhập OTP
            forgotPasswordModal.hide();
            verifyOtpModal.show();

            // Reset form
            document.getElementById('forgotPasswordForm').reset();
        } else {
            Swal.fire({
                icon: 'error',
                text: data.message,
                showConfirmButton: true
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            text: 'Có lỗi xảy ra, vui lòng thử lại sau',
            showConfirmButton: true
        });
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = 'Gửi mã xác nhận';
    });
});

// Xử lý nút "Chỉnh sửa" email trong modal OTP
document.getElementById('editEmailLink').addEventListener('click', function(e) {
    e.preventDefault();
    verifyOtpModal.hide();
    forgotPasswordModal.show();
});

// Xử lý nút "Chỉnh sửa" trong form quên mật khẩu
document.getElementById('editEmailBtn').addEventListener('click', function() {
    const emailInput = document.getElementById('forgotEmail');
    emailInput.readOnly = false;
    emailInput.focus();
});

// Xử lý input OTP
document.querySelectorAll('.otp-input').forEach((input, index) => {
    input.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value && index < 5) {
            document.querySelectorAll('.otp-input')[index + 1].focus();
        }
    });

    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !this.value && index > 0) {
            document.querySelectorAll('.otp-input')[index - 1].focus();
        }
    });

    // Ngăn chặn paste nhiều số
    input.addEventListener('paste', function(e) {
        e.preventDefault();
        const pastedData = e.clipboardData.getData('text');
        const numbers = pastedData.match(/\d/g);
        if (numbers) {
            const inputs = document.querySelectorAll('.otp-input');
            numbers.forEach((num, i) => {
                if (i < 6) {
                    inputs[i].value = num;
                    if (i < 5) inputs[i + 1].focus();
                }
            });
        }
    });
});

// Xử lý nút Xác minh OTP
document.getElementById('verifyOtpBtn').addEventListener('click', function() {
    const inputs = document.querySelectorAll('.otp-input');
    const otp = Array.from(inputs).map(input => input.value).join('');
    
    if (otp.length !== 6) {
        Swal.fire({
            icon: 'error',
            text: 'Vui lòng nhập đủ 6 số',
            showConfirmButton: true
        });
        return;
    }

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "accounts:verify_otp" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ otp: otp })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                text: 'Xác minh thành công',
                showConfirmButton: false,
                timer: 1500
            }).then(() => {
                // Đóng modal OTP và mở modal đặt mật khẩu mới
                verifyOtpModal.hide();
                resetPasswordModal.show();
            });
        } else {
            Swal.fire({
                icon: 'error',
                text: data.message || 'Mã OTP không chính xác',
                showConfirmButton: true
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            text: 'Có lỗi xảy ra, vui lòng thử lại',
            showConfirmButton: true
        });
    });
});

// Sửa lại phần xử lý form reset password
document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const email = document.getElementById('displayEmail').textContent;
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (newPassword !== confirmPassword) {
        Swal.fire({
            icon: 'error',
            text: 'Mật khẩu không khớp',
            showConfirmButton: true
        });
        return;
    }

    fetch('{% url "accounts:reset_password" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            email: email,
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Tự động đăng nhập sau khi đặt mật khẩu mới
            fetch('{% url "accounts:login" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                body: `username=${encodeURIComponent(email)}&password=${encodeURIComponent(newPassword)}`
            })
            .then(response => response.json())
            .then(loginData => {
                if (loginData.success) {
                    Swal.fire({
                        icon: 'success',
                        text: 'Đặt mật khẩu mới thành công',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        resetPasswordModal.hide();
                        window.location.reload(); // Reload trang sau khi đăng nhập thành công
                    });
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                text: data.message || 'Có lỗi xảy ra',
                showConfirmButton: true
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            text: 'Có lỗi xảy ra, vui lòng thử lại',
            showConfirmButton: true
        });
    });
});

// Xử lý form đăng ký
document.getElementById('registerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Disable nút đăng ký và hiển thị trạng thái loading
    const submitButton = this.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
    
    const formData = new FormData(this);
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "accounts:register" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Đóng modal đăng ký
            const registerModal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
            registerModal.hide();

            // Hiển thị thông báo thành công
            Swal.fire({
                icon: 'success',
                title: 'Đăng ký thành công!',
                text: 'Hệ thống sẽ gửi xác nhận qua Email của quý khách, vui lòng kiểm tra Email và hoàn tất quá trình đăng ký',
                showConfirmButton: true
            }).then((result) => {
                // Sau khi đóng thông báo, chuyển đến trang xác thực
                window.location.href = data.redirect;
            });
        } else {
            if (data.action === 'login') {
                Swal.fire({
                    icon: 'info',
                    title: 'Email đã tồn tại',
                    text: 'Email này đã được đăng ký. Vui lòng đăng nhập.',
                    showConfirmButton: true
                }).then(() => {
                    const registerModal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
                    registerModal.hide();
                    
                    const authModal = new bootstrap.Modal(document.getElementById('authModal'));
                    authModal.show();
                    
                    document.getElementById('loginUsername').value = formData.get('email');
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: data.error || 'Có lỗi xảy ra, vui lòng thử lại',
                    showConfirmButton: true
                });
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Lỗi',
            text: 'Có lỗi xảy ra, vui lòng thử lại sau',
            showConfirmButton: true
        });
    })
    .finally(() => {
        // Restore nút đăng ký về trạng thái ban đầu
        submitButton.disabled = false;
        submitButton.innerHTML = 'Đăng ký';
    });
});

// Xử lý nút gửi lại email xác thực
document.getElementById('resendVerifyEmailBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    
    const button = this;
    button.disabled = true;
    button.textContent = 'Đang gửi...';

    fetch('{% url "accounts:resend_verification_email" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                text: 'Đã gửi lại email xác thực',
                showConfirmButton: false,
                timer: 1500
            });
        } else {
            Swal.fire({
                icon: 'error',
                text: data.message || 'Có lỗi xảy ra',
                showConfirmButton: true
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            text: 'Có lỗi xảy ra, vui lòng thử lại',
            showConfirmButton: true
        });
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'Gửi lại email xác thực';
    });
});

// Xử lý form đăng nhập
document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "accounts:login" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.redirect) {
                window.location.href = data.redirect;
            } else {
                window.location.reload();
            }
        } else {
            if (data.action === 'suspended') {
                // Đóng modal đăng nhập nếu đang mở
                const loginModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
                if (loginModal) {
                    loginModal.hide();
                }

                // Hiển thị thông báo đình chỉ với CSS tùy chỉnh
                Swal.fire({
                    icon: 'error',
                    title: 'Tài khoản đã bị đình chỉ!',
                    html: `
                        <p>Lý do: ${data.reason || 'Không có lý do được cung cấp'}</p>
                        <div class="mt-3 text-center">
                            <p style="margin-bottom: 5px;">Đây có thể là nhầm lẫn?</p>
                            <a href="mailto:tomoivn2024@gmail.com" 
                               style="
                                   color: #df2626;
                                   text-decoration: none;
                                   font-weight: bold;
                                   display: inline-block;
                                   transition: color 0.3s ease;
                               "
                               onmouseover="this.style.color='#b91c1c'"
                               onmouseout="this.style.color='#df2626'"
                            >
                                Liên hệ với quản trị viên ngay
                            </a>
                        </div>
                    `,
                    showConfirmButton: true,
                    confirmButtonText: 'Đóng'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi đăng nhập',
                    text: data.message || 'Có lỗi xảy ra, vui lòng thử lại',
                    showConfirmButton: true
                });
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Lỗi',
            text: 'Có lỗi xảy ra, vui lòng thử lại sau',
            showConfirmButton: true
        });
    });
});

// Xử lý toggle password
document.querySelectorAll('.toggle-password').forEach(button => {
    button.addEventListener('click', function() {
        const input = this.previousElementSibling;
        const icon = this.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });
});

// Kiểm tra mật khẩu khi đăng ký
document.getElementById('registerPassword').addEventListener('input', function() {
    const password = this.value;
    const username = document.querySelector('input[name="username"]').value;
    const email = document.querySelector('input[name="email"]').value;

    // Kiểm tra độ dài
    const lengthCheck = document.getElementById('length-check');
    if (password.length >= 8) {
        lengthCheck.classList.remove('invalid');
        lengthCheck.classList.add('valid');
    } else {
        lengthCheck.classList.remove('valid');
        lengthCheck.classList.add('invalid');
    }

    // Kiểm tra không chỉ chứa số
    const numberCheck = document.getElementById('number-check');
    if (!/^[0-9]+$/.test(password)) {
        numberCheck.classList.remove('invalid');
        numberCheck.classList.add('valid');
    } else {
        numberCheck.classList.remove('valid');
        numberCheck.classList.add('invalid');
    }

    // Kiểm tra mật khẩu phổ biến
    const commonCheck = document.getElementById('common-check');
    const commonPasswords = ['password', '12345678', 'qwerty', '123456789'];
    if (!commonPasswords.includes(password.toLowerCase())) {
        commonCheck.classList.remove('invalid');
        commonCheck.classList.add('valid');
    } else {
        commonCheck.classList.remove('valid');
        commonCheck.classList.add('invalid');
    }

    // Kiểm tra giống username
    const personalCheck = document.getElementById('personal-check');
    if (!password.includes(username)) {
        personalCheck.classList.remove('invalid');
        personalCheck.classList.add('valid');
    } else {
        personalCheck.classList.remove('valid');
        personalCheck.classList.add('invalid');
    }
});
</script>
</body>
</html>

