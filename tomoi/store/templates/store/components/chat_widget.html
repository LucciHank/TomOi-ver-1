<div class="chatbot-widget" id="chatbotWidget">
    <div class="chatbot-toggle" id="chatToggle">
        <span>B·∫°n c·∫ßn t∆∞ v·∫•n? Chat ngay</span>
    </div>
    
    <div class="chatbot-container" id="chatContainer">
        <div class="chatbot-header">
            <div class="chatbot-title">
                <div class="chatbot-avatar">
                    <img src="/static/img/chatbot-avatar.png" alt="Chatbot">
                </div>
                <span>T∆∞ v·∫•n s·∫£n ph·∫©m</span>
            </div>
            <div class="chatbot-actions">
                <button class="btn-minimize" id="chatMinimize"><i class="fas fa-minus"></i></button>
                <button class="btn-close" id="chatClose"><i class="fas fa-times"></i></button>
            </div>
        </div>
        
        <div class="chatbot-messages" id="chatMessages">
            <div class="chat-message bot-message">
                <div class="message-avatar">
                    <img src="/static/img/chatbot-avatar.png" alt="Chatbot">
                </div>
                <div>
                    <div class="message-content">
                        Xin ch√†o! T√¥i l√† tr·ª£ l√Ω ·∫£o, c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n v·ªÅ s·∫£n ph·∫©m c·ªßa ch√∫ng t√¥i?
                    </div>
                    <div class="message-time">B√¢y gi·ªù</div>
                </div>
            </div>
            
            <div class="quick-questions">
                <button class="quick-question-btn" data-question="L√†m th·∫ø n√†o ƒë·ªÉ ƒë·ªïi m·∫≠t kh·∫©u?">L√†m th·∫ø n√†o ƒë·ªÉ ƒë·ªïi m·∫≠t kh·∫©u?</button>
                <button class="quick-question-btn" data-question="T√¥i c·∫ßn h·ªó tr·ª£ v·ªÅ t√†i kho·∫£n">T√¥i c·∫ßn h·ªó tr·ª£ v·ªÅ t√†i kho·∫£n</button>
                <button class="quick-question-btn" data-question="T√¥i mu·ªën t√¨m ·ª©ng d·ª•ng gi·∫£i tr√≠">T√¥i mu·ªën t√¨m ·ª©ng d·ª•ng gi·∫£i tr√≠</button>
            </div>
        </div>
        
        <div class="chatbot-input">
            <input type="text" id="chatInput" placeholder="Nh·∫≠p c√¢u h·ªèi..." />
            <button id="chatSend"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<style>
    .chatbot-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        font-family: Arial, sans-serif;
    }
    
    .chatbot-toggle {
        width: 180px;
        height: 50px;
        border-radius: 25px;
        background-color: #4e73df;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        padding: 10px 15px;
        font-weight: bold;
    }
    
    .chatbot-toggle:hover {
        transform: scale(1.05);
        background-color: #3a5bbf;
    }
    
    .chatbot-container {
        display: none;
        flex-direction: column;
        width: 350px;
        height: 500px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        position: absolute;
        bottom: 70px;
        right: 0;
        animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
        from {opacity: 0; transform: translateY(20px);}
        to {opacity: 1; transform: translateY(0);}
    }
    
    .chatbot-header {
        background-color: #4e73df;
        color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chatbot-title {
        display: flex;
        align-items: center;
    }
    
    .chatbot-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 10px;
        background-color: white;
        overflow: hidden;
    }
    
    .chatbot-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .chatbot-actions button {
        background: none;
        border: none;
        color: white;
        margin-left: 10px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .chatbot-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #f8f9fc;
        display: flex;
        flex-direction: column;
    }
    
    .chat-message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
    }
    
    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 10px;
        overflow: hidden;
    }
    
    .message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .bot-message .message-content {
        background-color: #f0f2f5;
        color: #333;
        border-radius: 18px;
        padding: 8px 12px;
        max-width: 80%;
        word-wrap: break-word;
    }
    
    .user-message {
        flex-direction: row-reverse;
    }
    
    .user-message .message-avatar {
        margin-right: 0;
        margin-left: 10px;
    }
    
    .user-message .message-content {
        background-color: #0084ff;
        color: white;
        border-radius: 18px;
        padding: 8px 12px;
        max-width: 80%;
        word-wrap: break-word;
    }
    
    .message-time {
        font-size: 11px;
        color: #999;
        margin-top: 4px;
    }
    
    .chatbot-input {
        padding: 15px;
        border-top: 1px solid #e9ecef;
        display: flex;
        background-color: white;
    }
    
    .chatbot-input input {
        flex: 1;
        border: 1px solid #ced4da;
        border-radius: 20px;
        padding: 8px 15px;
        outline: none;
    }
    
    .chatbot-input button {
        background-color: #4e73df;
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        margin-left: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chatbot-input button:hover {
        background-color: #3a5bbf;
    }
    
    .quick-questions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 10px 0;
    }
    
    .quick-question-btn {
        background-color: #e9ecef;
        border: none;
        border-radius: 18px;
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .quick-question-btn:hover {
        background-color: #dadce0;
    }
    
    /* Typing indicator */
    .typing {
        display: flex;
        align-items: center;
    }
    
    .typing .dot {
        width: 8px;
        height: 8px;
        background-color: #bbb;
        border-radius: 50%;
        margin: 0 2px;
        animation: typing 1.5s infinite ease-in-out;
    }
    
    .typing .dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing .dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }
    
    /* S·∫£n ph·∫©m carousel */
    .products-carousel {
        display: flex;
        overflow-x: auto;
        padding: 10px 0;
        margin: 10px 0;
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    .products-carousel::-webkit-scrollbar {
        display: none;
    }
    
    .product-card {
        min-width: 180px;
        max-width: 180px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        margin-right: 10px;
        background-color: white;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .product-image {
        height: 100px;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .product-image img {
        max-width: 100%;
        max-height: 90px;
        object-fit: contain;
    }
    
    .product-info {
        padding: 10px;
    }
    
    .product-name {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .product-price {
        font-size: 14px;
        color: #e44d26;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .product-action {
        display: flex;
        justify-content: center;
    }
    
    .product-action a {
        background-color: #4e73df;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 12px;
        transition: background-color 0.2s;
        cursor: pointer;
    }
    
    .product-action a:hover {
        background-color: #3a5bbf;
    }
    
    /* ƒê√°nh gi√° chatbot */
    .feedback-container {
        margin: 20px 0;
        text-align: center;
        padding: 10px;
        border-top: 1px solid #e9ecef;
    }
    
    .feedback-question {
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .feedback-options {
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    
    .feedback-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .feedback-btn:hover {
        transform: scale(1.2);
    }
    
    .feedback-thanks {
        color: #28a745;
        font-weight: bold;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatToggle = document.getElementById('chatToggle');
        const chatContainer = document.getElementById('chatContainer');
        const chatClose = document.getElementById('chatClose');
        const chatMinimize = document.getElementById('chatMinimize');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        
        // T·∫°o session ID ng·∫´u nhi√™n cho m·ªói phi√™n chat
        const sessionId = Math.random().toString(36).substring(2, 15);
        
        // M·ªü chat khi nh·∫•n v√†o icon
        chatToggle.addEventListener('click', function() {
            chatContainer.style.display = 'flex';
            chatToggle.style.display = 'none';
        });
        
        // ƒê√≥ng chat khi nh·∫•n n√∫t ƒë√≥ng
        chatClose.addEventListener('click', function() {
            chatContainer.style.display = 'none';
            chatToggle.style.display = 'flex';
        });
        
        // Thu nh·ªè chat khi nh·∫•n n√∫t thu nh·ªè
        chatMinimize.addEventListener('click', function() {
            chatContainer.style.display = 'none';
            chatToggle.style.display = 'flex';
        });
        
        // X·ª≠ l√Ω c√°c c√¢u h·ªèi g·ª£i √Ω
        document.querySelectorAll('.quick-question-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const question = this.getAttribute('data-question');
                addUserMessage(question);
                sendToBot(question);
            });
        });
        
        // H√†m l·∫•y CSRF token t·ª´ cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Hi·ªÉn th·ªã typing indicator
        function showTypingIndicator() {
            const typingHtml = `
                <div class="chat-message bot-message typing-indicator">
                    <div class="message-avatar">
                        <img src="/static/img/chatbot-avatar.png" alt="Chatbot">
                    </div>
                    <div class="typing">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += typingHtml;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // ·∫®n typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // G·ª≠i tin nh·∫Øn ƒë·∫øn chatbot
        function sendToBot(message) {
            // Hi·ªÉn th·ªã typing indicator
            showTypingIndicator();
            
            // G·ª≠i request ƒë·∫øn API
            fetch('/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    message: message,
                    session_id: sessionId
                })
            })
            .then(response => response.json())
            .then(data => {
                // ·∫®n typing indicator
                hideTypingIndicator();
                
                // Th√™m ph·∫£n h·ªìi t·ª´ chatbot
                addBotMessage(data.response);
                
                // Ki·ªÉm tra xem c√≥ s·∫£n ph·∫©m g·ª£i √Ω kh√¥ng
                if (data.products && data.products.length > 0) {
                    addProductsCarousel(data.products);
                }
                
                // Hi·ªÉn th·ªã ƒë√°nh gi√° sau m·ªôt s·ªë tin nh·∫Øn
                const messages = document.querySelectorAll('.chat-message');
                if (messages.length >= 6) {
                    // Ch·ªâ hi·ªÉn th·ªã n·∫øu ch∆∞a c√≥ ƒë√°nh gi√°
                    if (!document.querySelector('.feedback-container')) {
                        showFeedbackOptions();
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                hideTypingIndicator();
                addBotMessage('Xin l·ªói, ƒë√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.');
            });
        }
        
        // Th√™m tin nh·∫Øn ng∆∞·ªùi d√πng v√†o khung chat
        function addUserMessage(message) {
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const messageHtml = `
                <div class="chat-message user-message">
                    <div>
                        <div class="message-content">${message}</div>
                        <div class="message-time">${currentTime}</div>
                    </div>
                    <div class="message-avatar">
                        <img src="/static/img/user-avatar.png" alt="User">
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += messageHtml;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Th√™m tin nh·∫Øn bot v√†o khung chat
        function addBotMessage(message) {
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const messageHtml = `
                <div class="chat-message bot-message">
                    <div class="message-avatar">
                        <img src="/static/img/chatbot-avatar.png" alt="Chatbot">
                    </div>
                    <div>
                        <div class="message-content">${message}</div>
                        <div class="message-time">${currentTime}</div>
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += messageHtml;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Th√™m carousel s·∫£n ph·∫©m
        function addProductsCarousel(products) {
            let productsHtml = '<div class="products-carousel">';
            
            products.forEach(product => {
                productsHtml += `
                    <div class="product-card">
                        <div class="product-image">
                            <img src="${product.image}" alt="${product.name}">
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">${product.price}</div>
                            <div class="product-action">
                                <a href="${product.url}" target="_blank">Xem chi ti·∫øt</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            productsHtml += '</div>';
            
            chatMessages.innerHTML += productsHtml;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Hi·ªÉn th·ªã t√πy ch·ªçn ƒë√°nh gi√°
        function showFeedbackOptions() {
            const feedbackHtml = `
                <div class="feedback-container">
                    <div class="feedback-question">Cu·ªôc tr√≤ chuy·ªán c√≥ h·ªØu √≠ch kh√¥ng?</div>
                    <div class="feedback-options">
                        <button class="feedback-btn" data-value="1">üòû</button>
                        <button class="feedback-btn" data-value="2">üòê</button>
                        <button class="feedback-btn" data-value="3">üôÇ</button>
                        <button class="feedback-btn" data-value="4">üòä</button>
                        <button class="feedback-btn" data-value="5">üòç</button>
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += feedbackHtml;
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Th√™m s·ª± ki·ªán cho n√∫t ƒë√°nh gi√°
            document.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const rating = this.getAttribute('data-value');
                    sendFeedback(rating);
                    
                    // Hi·ªÉn th·ªã c·∫£m ∆°n
                    document.querySelector('.feedback-container').innerHTML = `
                        <div class="feedback-thanks">C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!</div>
                    `;
                });
            });
        }
        
        // G·ª≠i ƒë√°nh gi√° ƒë·∫øn server
        function sendFeedback(rating) {
            fetch('/api/chat/feedback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    rating: rating
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Feedback sent:', data);
            })
            .catch(error => {
                console.error('Error sending feedback:', error);
            });
        }
        
        // G·ª≠i tin nh·∫Øn khi click n√∫t g·ª≠i
        chatSend.addEventListener('click', function() {
            sendMessage();
        });
        
        // G·ª≠i tin nh·∫Øn khi nh·∫•n Enter
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // H√†m g·ª≠i tin nh·∫Øn
        function sendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                addUserMessage(message);
                chatInput.value = '';
                sendToBot(message);
            }
        }
        
        // B·ªï sung code cho x·ª≠ l√Ω hover v√† hi·ªáu ·ª©ng n√∫t
        document.querySelectorAll('.product-card').forEach(card => {
            card.addEventListener('mouseover', function() {
                this.style.transform = 'translateY(-3px)';
                this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
            });
            
            card.addEventListener('mouseout', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            });
        });
    });
</script>