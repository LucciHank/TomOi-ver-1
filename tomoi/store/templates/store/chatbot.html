{% load static %}
<!-- Chatbot Widget -->
<div id="tomoi-chatbot-widget">
    <!-- Nút Chat Avatar (hiển thị cố định) -->
    <div class="chat-launcher" id="chat-launcher">
        <div class="chat-launcher-button" onclick="openChatWindow(event)">
            {% if config.avatar %}
                <img src="{{ config.avatar.url }}" alt="Chat với chúng tôi">
            {% else %}
                <img src="{% static 'store/images/chatbot-avatar.png' %}" alt="Chat với chúng tôi">
            {% endif %}
        </div>
        <div class="chat-launcher-tooltip">Bạn cần tư vấn? Chat ngay</div>
        <div class="notification-badge" id="notification-badge" style="display: none;">1</div>
    </div>
    
    <!-- Khung Chat (ẩn mặc định) -->
    <div class="chat-window" id="chat-window">
        <div class="chat-header" style="background-color: {{ config.theme_color|default:'#df2626' }};">
            <div class="chat-avatar">
                {% if config.avatar %}
                    <img src="{{ config.avatar.url }}" alt="{{ config.chatbot_name|default:'TomOi Assistant' }}">
                {% else %}
                    <img src="{% static 'store/images/chatbot-avatar.png' %}" alt="{{ config.chatbot_name|default:'TomOi Assistant' }}">
                {% endif %}
            </div>
            <div class="chat-title">
                <div class="chat-name" id="chatbot-name">{{ config.chatbot_name|default:"TomOi Assistant" }}</div>
                <div class="chat-status">Đang hoạt động</div>
            </div>
            <div class="chat-actions">
                <button class="chatbot-reset" id="btn-reset" title="Xóa lịch sử"><i class="fas fa-trash"></i></button>
                <button class="btn-minimize" id="btn-minimize"><i class="fas fa-minus"></i></button>
                <button class="btn-close" id="btn-close"><i class="fas fa-times"></i></button>
            </div>
        </div>
        
        <div class="chat-body" id="chat-body">
            <div class="chat-messages" id="chat-messages">
                <!-- Tin nhắn chào mừng từ bot -->
                <div class="message bot">
                    <div class="message-avatar">
                        {% if config.avatar %}
                            <img src="{{ config.avatar.url }}" alt="{{ config.chatbot_name|default:'TomOi Assistant' }}">
                        {% else %}
                            <img src="{% static 'store/images/chatbot-avatar.png' %}" alt="{{ config.chatbot_name|default:'TomOi Assistant' }}">
                        {% endif %}
                    </div>
                    <div class="message-content">
                        <div class="message-text">Xin chào! Tôi là trợ lý của TomOi. Tôi có thể giúp gì cho bạn?</div>
                        <div class="message-time">{{ current_time|default:"Bây giờ" }}</div>
                    </div>
                </div>
                
                <!-- Gợi ý câu hỏi -->
                <div class="message bot suggestions">
                    <div class="message-avatar">
                        {% if config.avatar %}
                            <img src="{{ config.avatar.url }}" alt="{{ config.chatbot_name|default:'TomOi Assistant' }}">
                        {% else %}
                            <img src="{% static 'store/images/chatbot-avatar.png' %}" alt="{{ config.chatbot_name|default:'TomOi Assistant' }}">
                        {% endif %}
                    </div>
                    <div class="message-content">
                        <div class="message-text">Bạn có thể hỏi tôi:</div>
                        <div class="suggestion-buttons">
                            <button class="suggestion-btn" data-text="Có sản phẩm nào đang khuyến mãi?">Có sản phẩm nào đang khuyến mãi?</button>
                            <button class="suggestion-btn" data-text="Tôi muốn tìm ứng dụng giải trí">Tôi muốn tìm ứng dụng giải trí</button>
                            <button class="suggestion-btn" data-text="Làm thế nào để đổi mật khẩu?">Làm thế nào để đổi mật khẩu?</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-footer">
            <form id="chat-form">
                <div class="chat-input-wrapper">
                    <input type="text" id="chat-input" placeholder="Nhập tin nhắn..." autocomplete="off">
                    <button type="submit" class="btn-send" style="background-color: {{ config.theme_color|default:'#df2626' }};"><i class="fas fa-paper-plane"></i></button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Biến lưu trạng thái chat window
let isChatWindowOpen = false;
let chatbotConfig = null;
let lastMessage = '';
let isProcessing = false;
let messageHistory = []; // Lưu lịch sử hội thoại

// Thêm biến để theo dõi thời gian không hoạt động và timer
let inactivityTimer = null;
let lastInteractionTime = new Date();
let ratingShown = false;
let satisfactionRating = 0;

// Khởi tạo DOM elements
function initChat() {
    cacheElements();
    fetchChatbotConfig();
    
    // Gắn event cho chat launcher
    const chatLauncher = document.getElementById('chat-launcher');
    if (chatLauncher) {
        // Sửa lỗi bấm lần đầu tự tắt
        chatLauncher.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Launcher clicked");
            openChatWindow(); // Luôn mở cửa sổ chat khi bấm
        });
    }
    
    // Gắn event cho form
    const chatForm = document.getElementById('chat-form');
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const chatInput = document.getElementById('chat-input');
            if (chatInput && chatInput.value.trim()) {
                const message = chatInput.value.trim();
                chatInput.value = '';
                // Chỉ thêm và gửi một lần
                addUserMessage(message);
                sendMessageToAPI(message);
            }
        });
    }
    
    // Xử lý các nút gợi ý - chỉ chạy một lần
    document.querySelectorAll('.suggestion-btn').forEach(btn => {
        // Xóa handler cũ nếu có
        const oldClickHandler = btn.onclick;
        if (oldClickHandler) {
            btn.removeEventListener('click', oldClickHandler);
        }
        
        // Thêm handler mới với once: true
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const text = this.getAttribute('data-text');
            if (text) {
                console.log("Suggestion clicked:", text);
                addUserMessage(text);
                sendMessageToAPI(text);
                
                // Ẩn gợi ý sau khi bấm
                document.querySelector('.message.bot.suggestions')?.classList.add('hidden');
            }
        }, { once: true });
    });
}

// Lưu các reference DOM
function cacheElements() {
    elements = {
        chatWindow: document.getElementById('chat-window'),
        chatMessages: document.getElementById('chat-messages'),
        chatBody: document.getElementById('chat-body'),
        chatInput: document.getElementById('chat-input'),
        chatForm: document.getElementById('chat-form'),
        btnMinimize: document.getElementById('btn-minimize'),
        btnClose: document.getElementById('btn-close')
    };
    
    // Gắn sự kiện cho các nút
    if (elements.btnMinimize) {
        elements.btnMinimize.addEventListener('click', toggleChatWindow);
    }
    if (elements.btnClose) {
        elements.btnClose.addEventListener('click', toggleChatWindow);
    }
}

// Hàm mở cửa sổ chat
function openChatWindow() {
    console.log("openChatWindow called");
    if (!elements.chatWindow) {
        cacheElements();
    }
    
    if (!isChatWindowOpen) {
        elements.chatWindow.style.display = 'flex';
        elements.chatWindow.style.opacity = '1';
        elements.chatWindow.style.transform = 'translateY(0)';
        elements.chatWindow.style.zIndex = '1000';
        isChatWindowOpen = true;
        
        if (elements.chatInput) {
            elements.chatInput.focus();
        }
        
        scrollToBottom();
    }
}

// Hàm toggle chat window
function toggleChatWindow() {
    if (!elements.chatWindow) return;
    
    if (isChatWindowOpen) {
        elements.chatWindow.style.display = 'none';
        isChatWindowOpen = false;
    } else {
        openChatWindow();
    }
}

// Thêm các hàm để tương tác với database và tài liệu

// Hàm phân tích tin nhắn người dùng để xác định ý định
function analyzeUserIntent(message) {
    const lowerMessage = message.toLowerCase();
    let intent = null;
    let params = {};
    
    // Tìm kiếm sản phẩm theo giá
    if (lowerMessage.includes('sản phẩm') || lowerMessage.includes('mua') || lowerMessage.includes('giá')) {
        intent = 'search_products';
        
        // Tìm giá trong tin nhắn
        const priceMatch = lowerMessage.match(/(\d+)[k\s]*(đồng|vnd|₫)?/);
        if (priceMatch) {
            params.price = parseInt(priceMatch[1]);
            
            // Xác định nếu là "dưới X" hay "trên X"
            if (lowerMessage.includes('dưới') || lowerMessage.includes('ít hơn') || lowerMessage.includes('không quá')) {
                params.priceFilter = 'under';
            } else if (lowerMessage.includes('trên') || lowerMessage.includes('hơn') || lowerMessage.includes('từ')) {
                params.priceFilter = 'above';
            }
        }
        
        // Tìm danh mục sản phẩm
        if (lowerMessage.includes('game') || lowerMessage.includes('chơi')) {
            params.category = 'game';
        } else if (lowerMessage.includes('ứng dụng') || lowerMessage.includes('app')) {
            params.category = 'app';
        }
    }
    
    // Tìm kiếm thông tin từ tài liệu
    if (lowerMessage.includes('hướng dẫn') || lowerMessage.includes('cách') || lowerMessage.includes('làm sao')) {
        intent = 'documentation';
    }
    
    return { intent, params };
}

// Hàm tìm kiếm sản phẩm dựa trên tham số
function searchProducts(params) {
    return new Promise((resolve, reject) => {
        // Tạo query string từ params
        const queryParams = new URLSearchParams();
        
        if (params.price) {
            queryParams.append('price', params.price);
            queryParams.append('price_filter', params.priceFilter || 'under');
        }
        
        if (params.category) {
            queryParams.append('category', params.category);
        }
        
        // Gọi API tìm kiếm sản phẩm
        fetch(`/api/products/search?${queryParams.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể tìm kiếm sản phẩm');
                }
                return response.json();
            })
            .then(data => {
                resolve(data.products || []);
            })
            .catch(error => {
                console.error('Lỗi khi tìm kiếm sản phẩm:', error);
                reject(error);
            });
    });
}

// Hàm tạo HTML hiển thị card sản phẩm
function createProductCards(products, maxProducts = 3) {
    if (!products || products.length === 0) {
        return '<p>Không tìm thấy sản phẩm phù hợp.</p>';
    }
    
    // Giới hạn số lượng sản phẩm hiển thị
    const displayProducts = products.slice(0, maxProducts);
    
    let cardsHTML = '<div class="product-cards">';
    
    displayProducts.forEach(product => {
        cardsHTML += `
            <div class="product-card">
                <a href="${product.url}" target="_blank" class="product-link">
                    <div class="product-image">
                        <img src="${product.image_url}" alt="${product.name}">
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <p class="product-price">${formatPrice(product.price)} ₫</p>
                        <span class="view-details">Xem chi tiết</span>
                    </div>
                </a>
            </div>
        `;
    });
    
    if (products.length > maxProducts) {
        cardsHTML += `
            <div class="see-more">
                <a href="/search?q=${encodeURIComponent('sản phẩm')}" target="_blank">
                    Xem thêm ${products.length - maxProducts} sản phẩm khác
                </a>
            </div>
        `;
    }
    
    cardsHTML += '</div>';
    return cardsHTML;
}

// Hàm định dạng giá
function formatPrice(price) {
    return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Hàm tìm kiếm thông tin trong tài liệu
function searchDocumentation(query) {
    return new Promise((resolve, reject) => {
        fetch('/api/documentation/search', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Không thể tìm kiếm trong tài liệu');
            }
            return response.json();
        })
        .then(data => {
            resolve(data.results || []);
        })
        .catch(error => {
            console.error('Lỗi khi tìm kiếm trong tài liệu:', error);
            reject(error);
        });
    });
}

// Cập nhật hàm processSendMessage để xử lý các ý định đặc biệt
async function processSendMessage(message) {
    // Đảm bảo chúng ta có API key
    if (!chatbotConfig || !chatbotConfig.api_key) {
        console.error("Không tìm thấy API key");
        hideTypingIndicator();
        addBotMessage("Xin lỗi, không thể kết nối với trí tuệ nhân tạo. Vui lòng thử lại sau.");
        isProcessing = false;
        return;
    }
    
    // Phân tích ý định người dùng
    const userIntent = analyzeUserIntent(message);
    console.log("User intent:", userIntent);
    
    let contextualPrompt = '';
    let specialContent = null;
    
    // Xử lý ý định đặc biệt
    if (userIntent.intent === 'search_products') {
        try {
            const products = await searchProducts(userIntent.params);
            if (products.length > 0) {
                specialContent = createProductCards(products);
                contextualPrompt = `Người dùng đang tìm kiếm sản phẩm với giá ${userIntent.params.priceFilter === 'under' ? 'dưới' : 'trên'} ${userIntent.params.price}k. Tôi đã tìm thấy ${products.length} sản phẩm phù hợp. Hãy giới thiệu ngắn gọn về các sản phẩm này. Tôi sẽ hiển thị thông tin chi tiết sau phần giới thiệu của bạn.`;
            } else {
                contextualPrompt = `Người dùng đang tìm kiếm sản phẩm với giá ${userIntent.params.priceFilter === 'under' ? 'dưới' : 'trên'} ${userIntent.params.price}k, nhưng tôi không tìm thấy sản phẩm nào phù hợp. Hãy đề xuất một số giải pháp thay thế hoặc gợi ý cho người dùng.`;
            }
        } catch (error) {
            console.error("Lỗi khi tìm kiếm sản phẩm:", error);
        }
    } else if (userIntent.intent === 'documentation') {
        try {
            const docResults = await searchDocumentation(message);
            if (docResults.length > 0) {
                // Kết hợp kết quả tài liệu vào prompt
                contextualPrompt = `Người dùng đang hỏi: "${message}". Dựa trên tài liệu của chúng tôi, đây là thông tin liên quan:\n\n`;
                
                docResults.forEach((doc, idx) => {
                    contextualPrompt += `Tài liệu ${idx + 1}: ${doc.title}\n${doc.content}\n\n`;
                });
                
                contextualPrompt += "Vui lòng trả lời câu hỏi dựa trên thông tin trong tài liệu trên.";
            }
        } catch (error) {
            console.error("Lỗi khi tìm kiếm tài liệu:", error);
        }
    }
    
    // URL endpoint của Gemini API
    const apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${chatbotConfig.model || 'gemini-1.5-flash'}:generateContent?key=${chatbotConfig.api_key}`;
    
    // Tạo request body phù hợp với ngữ cảnh
    const requestContents = [];
    
    // KHÔNG sử dụng system role với Gemini vì không hỗ trợ
    // Thay vào đó, gộp contextualPrompt vào tin nhắn người dùng đầu tiên
    if (contextualPrompt) {
        // Thêm tin nhắn người dùng với contextualPrompt
        const firstMessage = {
            role: "user",
            parts: [{ text: contextualPrompt + "\n\nNgười dùng: " + message }]
        };
        requestContents.push(firstMessage);
    } else {
        // Thêm lịch sử hội thoại
        messageHistory.forEach(msg => {
            requestContents.push({
                role: msg.role,
                parts: [{ text: msg.content }]
            });
        });
    }
    
    // Gọi API trực tiếp
    fetch(apiEndpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            contents: requestContents,
            generationConfig: {
                temperature: chatbotConfig.temperature || 0.7,
                maxOutputTokens: 2048
            }
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Gemini API error: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        hideTypingIndicator();
        
        console.log("Gemini API response:", data);
        
        // Xử lý phản hồi từ Gemini API
        if (data?.candidates?.[0]?.content?.parts?.[0]?.text) {
            const botMessage = data.candidates[0].content.parts[0].text;
            
            // Định dạng tin nhắn từ markdown sang HTML
            let formattedMessage = formatMarkdownToHTML(botMessage);
            
            // Nếu có nội dung đặc biệt (như card sản phẩm), thêm vào sau tin nhắn
            if (specialContent) {
                formattedMessage += specialContent;
            }
            
            // Hiển thị tin nhắn
            addBotMessage(formattedMessage);
            
            // Lưu tin nhắn vào lịch sử
            messageHistory.push({ 
                role: "assistant", 
                content: botMessage  // Lưu tin nhắn gốc, không bao gồm nội dung đặc biệt
            });
            
            // Gửi log chat lên server
            logChatHistory(message, botMessage);
        } else {
            addBotMessage("Xin lỗi, tôi không thể xử lý yêu cầu của bạn lúc này.");
        }
    })
    .catch(error => {
        console.error("Lỗi khi gọi Gemini API:", error);
        hideTypingIndicator();
        
        // Kiểm tra nếu lỗi liên quan đến API key
        if (error.message.includes("API key")) {
            addBotMessage("Xin lỗi, có lỗi với kết nối API. Vui lòng thử lại sau.");
        } else {
            addBotMessage("Xin lỗi, tôi không thể xử lý yêu cầu của bạn lúc này.");
        }
    })
    .finally(() => {
        isProcessing = false;
    });
}

// Chuyển đổi markdown sang HTML
function formatMarkdownToHTML(text) {
    // Xử lý các thẻ markdown
    return text
        // Heading
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        
        // Bold và italic - làm rõ pattern để không còn hiển thị dấu **
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        
        // Xử lý điểm đậm (bullet points) với ngắt dòng tốt hơn
        .replace(/^\* (.*$)/gm, '<li>$1</li>')
        .replace(/^- (.*$)/gm, '<li>$1</li>')
        
        // Bọc các điểm đậm trong thẻ ul
        .replace(/(<li>.*<\/li>)(?!\s*<li>)/gs, '<ul>$1</ul>')
        
        // Links
        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>')
        
        // Xử lý ngắt dòng tốt hơn: 2 dấu xuống dòng liên tiếp thành thẻ đoạn văn
        .replace(/\n\n/g, '</p><p>')
        
        // Xử lý ngắt dòng đơn
        .replace(/\n/g, '<br>')
        
        // Đảm bảo văn bản được bọc trong thẻ p
        .replace(/^(.+)$/, '<p>$1</p>')
        
        // Sửa thẻ p lồng nhau
        .replace(/<p><p>/g, '<p>')
        .replace(/<\/p><\/p>/g, '</p>');
}

// Hàm thêm lỗi vào giao diện
function addErrorMessage(message) {
    const chatMessages = document.getElementById('chat-messages');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'message bot error';
    errorDiv.innerHTML = `
        <div class="message-avatar">
            <img src="/static/store/images/chatbot-avatar.png" alt="TomOi Assistant">
        </div>
        <div class="message-content">
            <div class="message-text error-text">
                <i class="fas fa-exclamation-circle"></i> 
                ${message}
            </div>
            <div class="message-time">Bây giờ</div>
        </div>
    `;
    chatMessages.appendChild(errorDiv);
    scrollToBottom();
}

// Hàm gửi tin nhắn đến API
function sendMessageToAPI(message) {
    if (isProcessing) return;
    
    isProcessing = true;
    lastMessage = message;
    
    // Hiển thị đang nhập
    showTypingIndicator();
    
    // Lưu vào lịch sử
    messageHistory.push({
        role: 'user',
        content: message
    });
    
    console.log("Gửi tin nhắn đến API:", message); 
    
    // Kiểm tra kết nối API
    if (!navigator.onLine) {
        hideTypingIndicator();
        addErrorMessage("Không có kết nối internet. Vui lòng kiểm tra kết nối của bạn.");
        isProcessing = false;
        return;
    }
    
    // Gọi API thực tế
    fetch('/accounts/api/public/chatbot-process/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            message: message,
            history: messageHistory.slice(-10) // Gửi 10 tin nhắn gần nhất
        })
    })
    .then(response => {
        console.log("Nhận response từ server, status:", response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Ẩn đang nhập
        hideTypingIndicator();
        
        console.log("Dữ liệu trả về:", data);
        
        if (data.success) {
            // Hiển thị phản hồi
            addBotMessage(data.response);
            
            // Thêm vào lịch sử
            messageHistory.push({
                role: 'assistant',
                content: data.response
            });
        } else {
            // Hiển thị lỗi
            console.error("Lỗi từ API:", data.message);
            addErrorMessage(data.message || 'Đã xảy ra lỗi khi xử lý tin nhắn');
        }
        
        isProcessing = false;
    })
    .catch(error => {
        console.error('Lỗi khi gửi tin nhắn:', error);
        hideTypingIndicator();
        addErrorMessage('Không thể kết nối đến máy chủ. Vui lòng thử lại sau hoặc liên hệ quản trị viên.');
        isProcessing = false;
    });
}

// Hàm lấy CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Hàm gửi log chat lên server - cập nhật endpoint chính xác
function logChatHistory(userMessage, botResponse) {
    console.log("Đang lưu lịch sử chat...");
    
    // Lấy CSRF token từ cookie
    const sessionId = getSessionId();
    const csrftoken = getCookie('csrftoken');
    
    // Dữ liệu gửi lên server
    const data = {
        session_id: sessionId,
        user_message: userMessage,
        bot_response: botResponse,
        metadata: JSON.stringify({
            ip_address: '',
            user_agent: navigator.userAgent,
            page_url: window.location.href,
            timestamp: new Date().toISOString()
        })
    };
    
    console.log("Gửi dữ liệu lịch sử chat:", data);
    
    // Thử lưu log bằng endpoint API đơn giản nhất
    fetch('/api/log-chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            session_id: sessionId,
            user_query: userMessage,
            assistant_response: botResponse,
            metadata: JSON.stringify({
                user_agent: navigator.userAgent,
                page_url: window.location.href
            })
        }),
        credentials: 'include'
    })
    .then(response => {
        console.log("Phản hồi API lưu lịch sử:", response.status);
        if (!response.ok) {
            return Promise.reject("Lỗi API: " + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log("Đã lưu lịch sử chat thành công:", data);
    })
    .catch(error => {
        console.warn("Lỗi khi lưu lịch sử chat:", error);
        console.log("Lưu chat vào local log:", {
            user_message: userMessage,
            bot_response: botResponse,
            timestamp: new Date().toISOString()
        });
    });
}

// Tạo session ID để phân biệt các cuộc trò chuyện
function getSessionId() {
    let sessionId = localStorage.getItem('tomoi_chat_session_id');
    if (!sessionId) {
        sessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substring(2, 10);
        localStorage.setItem('tomoi_chat_session_id', sessionId);
    }
    return sessionId;
}

// Thêm tin nhắn người dùng
function addUserMessage(message) {
    if (!elements.chatMessages) return;
    
    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Sử dụng local URL để tránh lỗi 404
    const messageHTML = `
        <div class="message user">
            <div class="message-avatar">
                <img src="{% static 'images/default-avatar.png' %}" alt="Bạn">
            </div>
            <div class="message-content">
                <div class="message-text">${message}</div>
                <div class="message-time">${timestamp}</div>
            </div>
        </div>
    `;
    
    elements.chatMessages.insertAdjacentHTML('beforeend', messageHTML);
    
    // Lưu vào history
    messageHistory.push({ role: "user", content: message, time: timestamp });
    
    scrollToBottom();
}

// Thêm tin nhắn bot với hiệu ứng typing
function addBotMessage(message) {
    if (!elements.chatMessages) return;
    
    // Làm mới thời gian tương tác
    resetInactivityTimer();
    
    // Loại bỏ các pattern không mong muốn
    message = message.replace(/chat log \(not sent\):.+/gi, '');

    
    // Giới hạn nội dung hiển thị về các tài khoản premium
    if (message.toLowerCase().includes('netflix') || 
        message.toLowerCase().includes('spotify') ||
        message.toLowerCase().includes('youtube premium') ||
        message.toLowerCase().includes('tài khoản premium')) {
        
        // Không cần thay đổi, đã đúng chủ đề
    } else if (!message.toLowerCase().includes('sản phẩm') && 
               !message.toLowerCase().includes('khuyến mãi') &&
               !message.toLowerCase().includes('tài khoản')) {
        // Thêm thông tin về sản phẩm của shop
        message += '<p>Chúng tôi chuyên cung cấp các tài khoản premium chất lượng cao như Netflix, Spotify, YouTube Premium và nhiều dịch vụ khác. Hãy cho tôi biết bạn đang tìm kiếm gói dịch vụ nào?</p>';
    }
    
    // Xử lý trường hợp lặp lại tin nhắn
    if (lastMessage && (message === lastMessage || message === lastMessage.substring(1))) {
        message = "Xin lỗi, tôi không thể xử lý yêu cầu của bạn lúc này.";
    }
    
    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const botAvatar = document.querySelector('.chat-avatar img')?.src || '{% static "store/images/chatbot-avatar.png" %}';
    const botName = document.getElementById('chatbot-name')?.textContent || 'TomOi Assistant';
    
    // Tạo container cho tin nhắn
    const messageContainer = document.createElement('div');
    messageContainer.className = 'message bot';
    messageContainer.innerHTML = `
        <div class="message-avatar">
            <img src="${botAvatar}" alt="${botName}">
        </div>
        <div class="message-content">
            <div class="message-text typing-effect"></div>
            <div class="message-time">${timestamp}</div>
        </div>
    `;
    
    elements.chatMessages.appendChild(messageContainer);
    scrollToBottom();
    
    // Element hiển thị text
    const textElement = messageContainer.querySelector('.message-text');
    
    // Áp dụng hiệu ứng typing nhanh
    const formattedMessage = formatMarkdownToHTML(message);
    
    // Tạo hiệu ứng typing
    let htmlWithoutTags = formattedMessage.replace(/<[^>]*>/g, ''); // Loại bỏ thẻ HTML để tính độ dài thực
    let typingSpeed = Math.min(10, Math.max(1, Math.floor(htmlWithoutTags.length / 100))); // Tự động điều chỉnh tốc độ
    
    // Đặt ngay nội dung HTML thay vì typing từng ký tự
    textElement.innerHTML = formattedMessage;
    textElement.classList.remove('typing-effect');
    
    // Lưu vào history
    messageHistory.push({ role: "assistant", content: message, time: timestamp });
    
    scrollToBottom();
    
    // Thiết lập lại timer để hiển thị đánh giá sau 1 phút không có tương tác
    resetInactivityTimer();
}

// Hiển thị typing indicator
function showTypingIndicator() {
    // Đảm bảo chỉ hiển thị một typing indicator
    hideTypingIndicator();
    
    if (!elements || !elements.chatMessages) {
        console.error("Không tìm thấy chatMessages element");
        return;
    }
    
    const botAvatar = document.querySelector('.chat-avatar img')?.src || '/static/store/images/chatbot-avatar.png';
    const botName = document.getElementById('chatbot-name')?.textContent || 'TomOi Assistant';
    
    const indicatorHTML = `
        <div class="message bot typing-indicator-container">
            <div class="message-avatar">
                <img src="${botAvatar}" alt="${botName}">
            </div>
            <div class="message-content">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;
    
    elements.chatMessages.insertAdjacentHTML('beforeend', indicatorHTML);
    scrollToBottom();
}

// Xóa typing indicator
function hideTypingIndicator() {
    // Đảm bảo DOM đã được load
    if (typeof document === 'undefined') return;
    
    const typingIndicator = document.querySelector('.typing-indicator-container');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Cuộn xuống tin nhắn mới nhất
function scrollToBottom() {
    if (elements.chatBody) {
        elements.chatBody.scrollTop = elements.chatBody.scrollHeight;
        console.log("Scrolled to bottom:", elements.chatBody.scrollHeight);
    }
}

// Lấy cấu hình chatbot từ server
function fetchChatbotConfig() {
    console.log("Đang lấy cấu hình chatbot...");
    
    return fetch('/accounts/api/public/chatbot-config/')
        .then(response => {
            if (!response.ok) {
                throw new Error('Không thể lấy cấu hình: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log("Config response:", data);
            if (data.success && data.config) {
                chatbotConfig = data.config;
                console.log("Đã tải cấu hình chatbot:", chatbotConfig);
                
                // Cập nhật UI với thông tin từ cấu hình
                document.getElementById('chatbot-name').textContent = chatbotConfig.chatbot_name;
                console.log("API key loaded:", 
                    chatbotConfig.api_key ? 
                    (chatbotConfig.api_key.substring(0, 5) + "...") : "Not found");
                console.log("API type:", chatbotConfig.api_type);
                console.log("Model:", chatbotConfig.model);
                return true;
            } else {
                console.error("Định dạng cấu hình không hợp lệ");
                return false;
            }
        })
        .catch(error => {
            console.error("Lỗi khi lấy cấu hình:", error);
            
            // Nếu gặp lỗi, tạo cấu hình mặc định
            chatbotConfig = {
                'chatbot_name': 'TomOi Assistant',
                'api_type': 'gemini',
                'model': 'gemini-1.5-flash'
            };
            
            console.log("Đã tạo cấu hình mặc định:", chatbotConfig);
            document.getElementById('chatbot-name').textContent = chatbotConfig.chatbot_name;
            
            return false;
        });
}

// Hàm đặt lại timer không hoạt động
function resetInactivityTimer() {
    lastInteractionTime = new Date();
    
    // Xóa timer cũ nếu có
    if (inactivityTimer) {
        clearTimeout(inactivityTimer);
    }
    
    // Xóa đánh giá cũ nếu có
    const ratingContainer = document.querySelector('.satisfaction-rating-container');
    if (ratingContainer) {
        ratingContainer.remove();
        ratingShown = false;
    }
    
    // Tạo timer mới - 60 giây
    inactivityTimer = setTimeout(() => {
        showSatisfactionRating();
    }, 60000); // 60000ms = 1 phút
}

// Hiển thị đánh giá mức độ hài lòng
function showSatisfactionRating() {
    // Chỉ hiển thị nếu chưa được hiển thị và có ít nhất một tin nhắn từ bot
    if (ratingShown || messageHistory.filter(msg => msg.role === "assistant").length === 0) {
        return;
    }
    
    ratingShown = true;
    
    const ratingContainer = document.createElement('div');
    ratingContainer.className = 'satisfaction-rating-container message bot';
    
    const botAvatar = document.querySelector('.chat-avatar img')?.src || '{% static "store/images/chatbot-avatar.png" %}';
    
    ratingContainer.innerHTML = `
        <div class="message-avatar">
            <img src="${botAvatar}" alt="TomOi Assistant">
        </div>
        <div class="message-content rating-content">
            <div class="rating-text">Bạn đánh giá phản hồi của TomAI như nào?</div>
            <div class="rating-stars">
                <span class="star" data-rating="1" title="Rất tệ"><i class="far fa-star"></i></span>
                <span class="star" data-rating="2" title="Tệ"><i class="far fa-star"></i></span>
                <span class="star" data-rating="3" title="Bình thường"><i class="far fa-star"></i></span>
                <span class="star" data-rating="4" title="Tốt"><i class="far fa-star"></i></span>
                <span class="star" data-rating="5" title="Rất tốt"><i class="far fa-star"></i></span>
            </div>
            <div class="rating-label"></div>
            <div class="feedback-container" style="display: none;">
                <textarea class="feedback-text" placeholder="Điểm cần cải thiện (không bắt buộc)"></textarea>
                <button class="send-feedback-btn">Gửi</button>
            </div>
            <div class="rating-action">
                <a href="#" class="give-feedback-link">Góp ý thêm</a>
            </div>
        </div>
    `;
    
    elements.chatMessages.appendChild(ratingContainer);
    scrollToBottom();
    
    // Thiết lập sự kiện cho các sao
    const stars = ratingContainer.querySelectorAll('.star');
    stars.forEach(star => {
        // Hiệu ứng hover
        star.addEventListener('mouseover', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            updateStars(stars, rating, true);
            
            // Hiển thị nhãn đánh giá
            const ratingLabel = ratingContainer.querySelector('.rating-label');
            let labelText = '';
            let labelColor = '';
            
            switch(rating) {
                case 1:
                    labelText = 'Rất tệ';
                    labelColor = '#e74a3b'; // Đỏ
                    break;
                case 2:
                    labelText = 'Tệ';
                    labelColor = '#f6c23e'; // Cam
                    break;
                case 3:
                    labelText = 'Bình thường';
                    labelColor = '#f6c23e'; // Vàng
                    break;
                case 4:
                    labelText = 'Tốt';
                    labelColor = '#1cc88a'; // Xanh lá nhạt
                    break;
                case 5:
                    labelText = 'Rất tốt';
                    labelColor = '#1cc88a'; // Xanh lá
                    break;
            }
            
            ratingLabel.textContent = `${rating}: ${labelText}`;
            ratingLabel.style.color = labelColor;
        });
        
        // Sự kiện mouseout
        star.addEventListener('mouseout', function() {
            if (satisfactionRating > 0) {
                updateStars(stars, satisfactionRating, true);
            } else {
                updateStars(stars, 0, false);
                ratingContainer.querySelector('.rating-label').textContent = '';
            }
        });
        
        // Sự kiện click để đánh giá
        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            satisfactionRating = rating;
            updateStars(stars, rating, true);
            
            // Gửi đánh giá lên server
            submitRating(rating);
        });
    });
    
    // Sự kiện cho nút góp ý thêm
    const feedbackLink = ratingContainer.querySelector('.give-feedback-link');
    feedbackLink.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Hiển thị ô góp ý
        const feedbackContainer = ratingContainer.querySelector('.feedback-container');
        feedbackContainer.style.display = 'block';
        this.parentElement.style.display = 'none';
    });
    
    // Sự kiện cho nút gửi góp ý
    const sendFeedbackBtn = ratingContainer.querySelector('.send-feedback-btn');
    sendFeedbackBtn.addEventListener('click', function() {
        const feedbackText = ratingContainer.querySelector('.feedback-text').value.trim();
        if (feedbackText) {
            submitFeedback(feedbackText);
        }
        
        // Ẩn khung góp ý và hiển thị thông báo cảm ơn
        ratingContainer.querySelector('.feedback-container').style.display = 'none';
        ratingContainer.querySelector('.rating-content').innerHTML += '<div class="thank-you-message">Cảm ơn bạn đã đánh giá và góp ý!</div>';
    });
}

// Cập nhật hiển thị sao
function updateStars(stars, rating, fill) {
    stars.forEach((star, index) => {
        const starIcon = star.querySelector('i');
        if (fill && index < rating) {
            starIcon.className = 'fas fa-star'; // Sao đặc
            star.classList.add('selected');
        } else {
            starIcon.className = 'far fa-star'; // Sao rỗng
            star.classList.remove('selected');
        }
    });
}

// Gửi đánh giá lên server
function submitRating(rating) {
    const sessionId = getSessionId();
    
    fetch('/api/rate-chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            session_id: sessionId,
            rating: rating
        }),
        credentials: 'include'
    })
    .then(response => {
        console.log("Đã gửi đánh giá:", response.status);
    })
    .catch(error => {
        console.warn("Lỗi khi gửi đánh giá:", error);
    });
}

// Gửi feedback lên server
function submitFeedback(feedback) {
    const sessionId = getSessionId();
    
    fetch('/api/feedback-chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            session_id: sessionId,
            feedback: feedback,
            rating: satisfactionRating
        }),
        credentials: 'include'
    })
    .then(response => {
        console.log("Đã gửi góp ý:", response.status);
    })
    .catch(error => {
        console.warn("Lỗi khi gửi góp ý:", error);
    });
}

// Khởi tạo chatbot khi trang đã tải xong
document.addEventListener('DOMContentLoaded', initChat);
</script>

<style>
/* CSS cơ bản cho chatbot */
#tomoi-chatbot-widget {
    font-family: 'Roboto', sans-serif;
}

/* Nút chat - Chỉnh sửa vị trí và hiệu ứng */
.chat-launcher {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 9999;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
}

.chat-launcher:hover {
    transform: scale(1.05);
}

/* Hiệu ứng rung */
@keyframes shake {
    0% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-2px) rotate(-1deg); }
    20%, 40%, 60%, 80% { transform: translateX(2px) rotate(1deg); }
    100% { transform: translateX(0); }
}

.shake {
    animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) both;
}

.chat-launcher-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    position: relative;
    z-index: 2;
    cursor: pointer;
}

.chat-launcher-button img {
    width: 70%;
    height: 70%;
    object-fit: contain;
}

/* Tooltip trượt từ phải sang trái - cải thiện */
.chat-launcher-tooltip {
    background-color: white;
    color: #333;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 13px;
    white-space: nowrap;
    position: absolute;
    right: 70px;
    max-width: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    border: 1px solid #eee;
    font-weight: 500;
}

.chat-launcher:hover .chat-launcher-tooltip {
    max-width: 200px;
    opacity: 1;
    right: 75px;
}

/* Badge thông báo */
.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background-color: #ff3b30;
    color: white;
    font-size: 12px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    z-index: 3;
}

/* Khung chat - cải thiện hiển thị */
.chat-window {
    display: none;
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 400px; /* Tăng từ 350px lên 400px */
    max-width: calc(100vw - 40px);
    height: 600px; /* Tăng từ 500px lên 600px */
    max-height: calc(100vh - 100px);
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 5px 30px rgba(0, 0, 0, 0.2);
    z-index: 1000 !important;
    flex-direction: column;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

/* Thêm class active để control việc hiện/ẩn */
.chat-window.active {
    display: flex !important;
}

/* Header của khung chat */
.chat-header {
    padding: 15px;
    background-color: #df2626;
    color: white;
    display: flex;
    align-items: center;
}

.chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    background-color: white;
    margin-right: 10px;
}

.chat-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.chat-title {
    flex: 1;
}

.chat-name {
    font-weight: bold;
    font-size: 16px;
}

.chat-status {
    font-size: 12px;
    opacity: 0.8;
}

.chat-actions {
    display: flex;
}

.chat-actions button {
    background: none;
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;
    margin-left: 5px;
    opacity: 0.8;
    transition: all 0.2s;
}

.chat-actions button:hover {
    opacity: 1;
}

/* Body của khung chat */
.chat-body {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background-color: #f5f5f5;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch; /* Cải thiện cuộn trên iOS */
}

.chat-messages {
    display: flex;
    flex-direction: column;
}

/* Tin nhắn */
.message {
    display: flex;
    margin-bottom: 15px;
    max-width: 85%;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.user {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.message.bot {
    align-self: flex-start;
}

.message-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 10px;
    background-color: white;
    flex-shrink: 0;
}

.message.user .message-avatar {
    margin-right: 0;
    margin-left: 10px;
}

.message-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.message-content {
    background-color: white;
    padding: 10px 15px;
    border-radius: 15px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    word-break: break-word;
}

.message.user .message-content {
    background-color: #df2626;
    color: white;
}

.message-text {
    font-size: 14px;
    line-height: 1.5;
}

.message-text h1 {
    font-size: 18px;
    margin: 8px 0;
}

.message-text h2 {
    font-size: 16px;
    margin: 6px 0;
}

.message-text h3 {
    font-size: 14px;
    margin: 4px 0;
}

.message-text strong {
    font-weight: bold;
}

.message-text em {
    font-style: italic;
}

.message-text ul {
    margin-left: 20px;
    padding-left: 0;
}

.message-text li {
    margin-bottom: 4px;
}

.message-text a {
    color: #0066cc;
    text-decoration: underline;
}

/* Hiệu ứng typing cho tin nhắn bot */
@keyframes typing {
    from { width: 0 }
    to { width: 100% }
}

.typing-effect {
    overflow: hidden;
    border-right: 2px solid #333;
    white-space: nowrap;
    animation: 
        typing 1.5s steps(40, end),
        blink-caret 0.75s step-end infinite;
}

@keyframes blink-caret {
    from, to { border-color: transparent }
    50% { border-color: #333 }
}

.message-time {
    font-size: 10px;
    color: #999;
    margin-top: 5px;
    text-align: right;
}

.message.user .message-time {
    color: rgba(255, 255, 255, 0.8);
}

/* Gợi ý tin nhắn */
.suggestion-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 8px;
}

.suggestion-btn {
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 15px;
    padding: 5px 10px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.suggestion-btn:hover {
    background-color: #df2626;
    color: white;
    border-color: #df2626;
}

/* Footer của khung chat */
.chat-footer {
    padding: 10px 15px;
    border-top: 1px solid #eee;
    background-color: white;
}

.chat-input-wrapper {
    display: flex;
    align-items: center;
}

#chat-input {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
}

#chat-input:focus {
    border-color: #df2626;
}

.btn-send {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    background-color: #df2626;
    color: white;
    border: none;
    margin-left: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-send:hover {
    background-color: #c72020;
    transform: scale(1.05);
}

/* Thêm CSS cho typing indicator */
.typing-indicator {
    display: flex;
    padding: 6px 10px;
}

.typing-indicator span {
    height: 8px;
    width: 8px;
    background-color: #bbb;
    border-radius: 50%;
    display: inline-block;
    margin: 0 1px;
    animation: pulse 1.5s infinite ease-in-out;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 0.6; }
    50% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); opacity: 0.6; }
}

/* Cho phép chạm vào trên thiết bị di động */
#chat-launcher, .chat-window {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}

/* Ẩn nút gợi ý sau khi đã bấm */
.message.bot.suggestions.hidden {
    display: none;
}

/* CSS cho card sản phẩm */
.product-cards {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 15px;
    width: 100%;
}

.product-card {
    border: 1px solid #eee;
    border-radius: 8px;
    overflow: hidden;
    background-color: white;
    transition: transform 0.2s, box-shadow 0.2s;
}

.product-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.product-link {
    display: flex;
    text-decoration: none;
    color: inherit;
}

.product-image {
    width: 80px;
    height: 80px;
    flex-shrink: 0;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-info {
    padding: 8px 12px;
    flex: 1;
}

.product-name {
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 4px 0;
    color: #333;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.product-price {
    color: #df2626;
    font-weight: bold;
    margin: 0;
    font-size: 13px;
}

.view-details {
    display: inline-block;
    margin-top: 5px;
    font-size: 12px;
    color: #0066cc;
}

.see-more {
    text-align: center;
    margin-top: 10px;
}

.see-more a {
    color: #0066cc;
    font-size: 13px;
    text-decoration: none;
}

.see-more a:hover {
    text-decoration: underline;
}

/* Styles for chat launcher and window */
#tomoi-chatbot-widget {
    font-family: 'Roboto', sans-serif;
}

/* Styles cho phần đánh giá mức độ hài lòng */
.satisfaction-rating-container {
    margin-top: 20px;
    margin-bottom: 10px;
}

.rating-content {
    padding: 15px;
    background-color: #f8f9fc;
    border: 1px solid #e3e6f0;
    border-radius: 10px;
}

.rating-text {
    font-weight: 500;
    margin-bottom: 10px;
    text-align: center;
}

.rating-stars {
    display: flex;
    margin-left: -5px;
}

.star {
    font-size: 24px;
    color: #f6c23e;
    cursor: pointer;
    padding: 0 5px;
    transition: transform 0.2s;
}

.star:hover {
    transform: scale(1.2);
}

.star.selected {
    color: #f6c23e;
}

.rating-label {
    text-align: center;
    font-weight: 500;
    height: 20px;
    margin: 5px 0;
}

.rating-action {
    text-align: center;
    margin-top: 10px;
}

.give-feedback-link {
    color: #4e73df;
    text-decoration: none;
    font-size: 14px;
}

.give-feedback-link:hover {
    text-decoration: underline;
}

.feedback-container {
    margin-top: 10px;
}

.feedback-text {
    width: 100%;
    padding: 8px;
    border: 1px solid #d1d3e2;
    border-radius: 5px;
    resize: vertical;
    min-height: 60px;
    margin-bottom: 10px;
}

.send-feedback-btn {
    background-color: #4e73df;
    color: white;
    border: none;
    padding: 5px 15px;
    border-radius: 5px;
    cursor: pointer;
    float: right;
}

.send-feedback-btn:hover {
    background-color: #2e59d9;
}

.thank-you-message {
    text-align: center;
    margin-top: 10px;
    color: #1cc88a;
    font-weight: 500;
}
</style>