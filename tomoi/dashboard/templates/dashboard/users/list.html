{% extends 'dashboard/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Quản lý người dùng{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<style>
    /* Định dạng cho avatar placeholder */
    .avatar-placeholder {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        border-radius: 50%;
        background-color: #4e73df;
    }
    
    /* Hiệu ứng hover cho hàng trong bảng */
    #usersTable tbody tr {
        transition: background-color 0.2s;
    }
    
    #usersTable tbody tr:hover {
        background-color: rgba(0,123,255,0.05);
    }
    
    /* Định dạng cho các badge */
    .badge {
        padding: 0.4em 0.6em;
        font-size: 85%;
    }
    
    .badge.bg-regular {
        background-color: #6c757d;
        color: white !important;
    }
    
    .badge.bg-premium {
        background-color: #17a2b8;
        color: white !important;
    }
    
    .badge.bg-vip {
        background-color: #ffc107;
        color: white !important;
    }
    
    /* Định dạng input search */
    #searchInput {
        border-right: none;
    }
    
    #search-addon {
        background-color: white;
        border-left: none;
    }
    
    /* Định dạng input search placeholder */
    #searchInput::placeholder {
        color: #adb5bd;
        font-style: italic;
    }
    
    /* Định dạng cho phần lọc */
    .filter-section {
        background-color: #f8f9fc;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        border: 1px solid #e3e6f0;
    }
    
    .filter-title {
        font-weight: 700;
        color: #4e73df;
        margin-bottom: 1.2rem;
        text-align: center;
        font-size: 1.2rem;
        border-bottom: 2px solid #e3e6f0;
        padding-bottom: 0.7rem;
        text-transform: uppercase;
    }
    
    .filter-subtitle {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 0.7rem;
        font-size: 0.9rem;
        text-align: center;
        position: relative;
    }
    
    .filter-subtitle:after {
        content: '';
        display: block;
        width: 50px;
        height: 2px;
        background-color: #4e73df;
        position: absolute;
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%);
    }
    
    /* Cải thiện card bộ lọc */
    .filter-card {
        border: 1px solid #e3e6f0;
        box-shadow: 0 0.1rem 0.5rem rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
        overflow: hidden;
    }
    
    .filter-card:hover {
        border-color: #bac8f3;
        box-shadow: 0 0.15rem 0.75rem rgba(78, 115, 223, 0.15);
    }
    
    /* Cải thiện hiển thị checkboxes */
    .filter-options {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background-color: #f8f9fc;
        border-radius: 0.35rem;
        border: 1px solid #e3e6f0;
        justify-content: center;
    }
    
    .form-check-inline {
        margin-right: 0.75rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }
    
    .form-check-input {
        margin-top: 0;
        margin-right: 0.3rem;
    }
    
    .form-check-label {
        font-size: 0.85rem;
        color: #5a5c69;
        margin-bottom: 0;
    }
    
    /* Nút lọc */
    .filter-buttons {
        display: flex;
        justify-content: center;
        margin-top: 1.5rem;
        gap: 15px;
    }
    
    .btn-filter {
        padding: 0.5rem 1.2rem;
        font-weight: 600;
        transition: all 0.3s;
        border-radius: 0.35rem;
    }
    
    .btn-filter i {
        margin-right: 8px;
    }
    
    /* Trạng thái online/offline */
    .status-online {
        color: #1cc88a;
        font-weight: 600;
    }
    
    .status-offline {
        color: #858796;
    }
    
    /* Gap cho các input */
    .gap-2 {
        gap: 0.5rem;
    }
    
    .d-flex.gap-2 > input {
        width: 50%;
    }
    
    .me-2 {
        margin-right: 0.5rem;
    }
    
    /* Màu nền và chữ cho Trạng thái */
    .badge.bg-success {
        background-color: #1cc88a;
        color: white !important;
    }
    
    .badge.bg-danger {
        background-color: #e74a3b;
        color: white !important;
    }
    
    .badge.bg-warning {
        background-color: #f6c23e;
        color: white !important;
    }
    
    .badge.bg-secondary {
        background-color: #858796;
        color: white !important;
    }
    
    /* Màu nền và chữ cho Nhóm người dùng */
    .badge.bg-admin {
        background-color: #4e73df;
        color: white !important;
    }
    
    .badge.bg-customer {
        background-color: #36b9cc;
        color: white !important;
    }
    
    .badge.bg-staff {
        background-color: #1cc88a;
        color: white !important;
    }
    
    .badge.bg-collaborator {
        background-color: #f6c23e;
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-gray-800">
            <i class="fas fa-users mr-2"></i>Quản Lý Người Dùng
        </h1>
        <div>
            <a href="{% url 'dashboard:user_add' %}" class="btn btn-primary btn-sm">
                <i class="fas fa-user-plus mr-2"></i>Thêm Người Dùng
            </a>
            <button type="button" class="btn btn-success btn-sm ml-2" id="importExcelBtn">
                <i class="fas fa-file-excel mr-2"></i>Tạo nhanh bằng Excel
            </button>
            <button type="button" class="btn btn-info btn-sm ml-2" id="exportExcelBtn">
                <i class="fas fa-file-export mr-2"></i>Xuất ra Excel
            </button>
        </div>
    </div>

    <!-- Phần tìm kiếm và lọc -->
    <div class="filter-section">
        <div class="row align-items-center mb-3">
            <div class="col-md-6">
                <h5 class="filter-title mb-0">Tìm kiếm và Lọc Người Dùng</h5>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm người dùng...">
                    <div class="input-group-append">
                        <span class="input-group-text" id="search-addon">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Cột 1: Trạng thái và Loại tài khoản -->
            <div class="col-md-4">
                <div class="card h-100 filter-card">
                    <div class="card-body p-3">
                        <div class="mb-3">
                            <div class="filter-subtitle">Trạng thái</div>
                            <div class="filter-options">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input filter-status" type="checkbox" id="statusActive" value="active">
                                    <label class="form-check-label" for="statusActive">Hoạt động</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input filter-status" type="checkbox" id="statusInactive" value="inactive">
                                    <label class="form-check-label" for="statusInactive">Không hoạt động</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input filter-status" type="checkbox" id="statusPending" value="pending">
                                    <label class="form-check-label" for="statusPending">Chờ xác nhận</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input filter-status" type="checkbox" id="statusBlocked" value="blocked">
                                    <label class="form-check-label" for="statusBlocked">Đã chặn</label>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="filter-subtitle">Loại tài khoản</div>
                            <div class="filter-options">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input filter-account-type" type="checkbox" id="accountTypeVip" value="vip">
                                    <label class="form-check-label" for="accountTypeVip">VIP</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input filter-account-type" type="checkbox" id="accountTypePremium" value="premium">
                                    <label class="form-check-label" for="accountTypePremium">Premium</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input filter-account-type" type="checkbox" id="accountTypeRegular" value="regular">
                                    <label class="form-check-label" for="accountTypeRegular">Thường</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cột 2: Ngày tham gia, Số dư và TCoin -->
            <div class="col-md-4">
                <div class="card h-100 filter-card">
                    <div class="card-body p-3">
                        <div class="mb-3">
                            <div class="filter-subtitle">Ngày tham gia</div>
                            <input type="text" id="joinDateRange" class="form-control daterangepicker-input" placeholder="Chọn khoảng thời gian...">
                        </div>
                        
                        <div class="mb-3">
                            <div class="filter-subtitle">Số dư (VNĐ)</div>
                            <div class="d-flex gap-2">
                                <input type="number" id="balanceMin" class="form-control me-2" placeholder="Tối thiểu">
                                <input type="number" id="balanceMax" class="form-control" placeholder="Tối đa">
                            </div>
                        </div>
                        
                        <div>
                            <div class="filter-subtitle">TCoin</div>
                            <div class="d-flex gap-2">
                                <input type="number" id="tcoinMin" class="form-control me-2" placeholder="Tối thiểu">
                                <input type="number" id="tcoinMax" class="form-control" placeholder="Tối đa">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cột 3: Hoạt động và Sắp xếp -->
            <div class="col-md-4">
                <div class="card h-100 filter-card">
                    <div class="card-body p-3">
                        <div class="mb-3">
                            <div class="filter-subtitle">Lọc theo hoạt động</div>
                            <div class="filter-options">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input filter-activity" type="checkbox" id="hasTransaction" value="transaction">
                                    <label class="form-check-label" for="hasTransaction">Đã từng giao dịch</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input filter-activity" type="checkbox" id="hasOrder" value="order">
                                    <label class="form-check-label" for="hasOrder">Đã từng mua hàng</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="filter-subtitle">Sắp xếp</div>
                            <select id="sortOption" class="form-control">
                                <option value="username|asc">Tên (A-Z)</option>
                                <option value="username|desc">Tên (Z-A)</option>
                                <option value="balance|asc">Số dư (Thấp-Cao)</option>
                                <option value="balance|desc">Số dư (Cao-Thấp)</option>
                                <option value="tcoin|asc">TCoin (Thấp-Cao)</option>
                                <option value="tcoin|desc">TCoin (Cao-Thấp)</option>
                                <option value="date_joined|asc">Đăng ký (Cũ nhất)</option>
                                <option value="date_joined|desc">Đăng ký (Mới nhất)</option>
                                <option value="last_login|asc">Đăng nhập (Lâu nhất)</option>
                                <option value="last_login|desc">Đăng nhập (Mới nhất)</option>
                            </select>
                        </div>
                        
                        <div class="filter-buttons">
                            <button id="applyFilters" class="btn btn-primary btn-filter">
                                <i class="fas fa-filter"></i>Lọc
                            </button>
                            <button id="resetFilters" class="btn btn-secondary btn-filter">
                                <i class="fas fa-redo"></i>Đặt lại
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hiển thị số lượng kết quả -->
    <div class="mb-3">
        <span id="resultCount">0</span> người dùng được tìm thấy
    </div>

    <!-- Danh sách người dùng -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary text-center">Danh sách người dùng</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="usersTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Người dùng</th>
                            <th>SĐT</th>
                            <th>Trạng thái</th>
                            <th>Loại tài khoản</th>
                            <th>Nhóm</th>
                            <th>Số dư</th>
                            <th>TCoin</th>
                            <th>Đăng nhập gần nhất</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr data-gender="{{ user.gender|default:'other' }}" 
                            data-join-date="{{ user.date_joined|date:'Y-m-d' }}" 
                            data-has-transactions="{{ user.has_transactions|default:'false' }}" 
                            data-has-orders="{{ user.has_orders|default:'false' }}">
                            <td>{{ forloop.counter }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if user.avatar %}
                                        <img src="{{ user.avatar.url }}" class="img-profile rounded-circle" width="40">
                                    {% else %}
                                        <img src="{% static 'dashboard/images/default-avatar.png' %}" class="img-profile rounded-circle" width="40">
                                    {% endif %}
                                    <div>
                                        <div class="font-weight-bold">{{ user.username }}</div>
                                        <div class="small text-muted">{{ user.email }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>{{ user.phone|default:"-" }}</td>
                            <td>
                                {% if user.is_active %}
                                <span class="badge bg-success">Hoạt động</span>
                                {% else %}
                                <span class="badge bg-danger">Không hoạt động</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.account_type == 'vip' %}
                                <span class="badge bg-vip">VIP</span>
                                {% elif user.account_type == 'premium' %}
                                <span class="badge bg-premium">Premium</span>
                                {% else %}
                                <span class="badge bg-regular">Thường</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.is_superuser %}
                                <span class="badge bg-admin">Admin</span>
                                {% elif user.is_staff %}
                                <span class="badge bg-staff">Nhân viên</span>
                                {% elif user.is_collaborator %}
                                <span class="badge bg-collaborator">Cộng tác viên</span>
                                {% else %}
                                <span class="badge bg-customer">Khách hàng</span>
                                {% endif %}
                            </td>
                            <td>{{ user.balance|intcomma }}đ</td>
                            <td>{{ user.tcoin_balance|default_if_none:0|intcomma }}</td>
                            <td>
                                {% if user.is_online %}
                                <span class="status-online"><i class="fas fa-circle fa-xs mr-1"></i> Online</span>
                                {% elif user.last_login %}
                                <span class="status-offline">{{ user.last_login|timesince }} trước</span>
                                {% else %}
                                <span class="text-muted">Chưa đăng nhập</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'dashboard:user_detail' user.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'dashboard:user_edit' user.id %}" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger delete-user-btn" 
                                            data-user-id="{{ user.id }}" data-username="{{ user.username }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal nhập Excel -->
<div class="modal fade" id="importExcelModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tạo nhanh người dùng từ Excel</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'dashboard:import_users' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-4">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle mr-2"></i> 
                            Tải lên file Excel có các cột: username, email, password, first_name, last_name, phone, account_type
                        </div>
                        
                        <div class="custom-file mb-3">
                            <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx, .xls" required>
                        </div>
                        
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendNotification" name="send_notification">
                                <label class="form-check-label" for="sendNotification">
                                    <i class="fas fa-envelope text-info mr-1"></i> Gửi email thông báo cho người dùng
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="exampleTable" class="mt-3">
                        <h6 class="mb-2 text-center">Ví dụ mẫu Excel</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>username</th>
                                        <th>email</th>
                                        <th>password</th>
                                        <th>first_name</th>
                                        <th>last_name</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>user123</td>
                                        <td>user@example.com</td>
                                        <td>Abc@123</td>
                                        <td>Nguyễn</td>
                                        <td>Văn A</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload me-1"></i> Tải lên và tạo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal xuất Excel -->
<div class="modal fade" id="exportModal" tabindex="-1" role="dialog" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">Xuất dữ liệu người dùng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="font-weight-bold">Chọn định dạng xuất dữ liệu:</label>
                    <div class="mt-2">
                        <div class="custom-control custom-radio mb-2">
                            <input type="radio" id="formatExcel" name="exportFormat" class="custom-control-input" value="excel" checked>
                            <label class="custom-control-label" for="formatExcel">
                                <i class="fas fa-file-excel text-success mr-2"></i>Excel (.xlsx)
                                <small class="text-muted d-block ml-4">Dễ chỉnh sửa và phân tích</small>
                            </label>
                        </div>
                        <div class="custom-control custom-radio mb-2">
                            <input type="radio" id="formatCsv" name="exportFormat" class="custom-control-input" value="csv">
                            <label class="custom-control-label" for="formatCsv">
                                <i class="fas fa-file-csv text-primary mr-2"></i>CSV
                                <small class="text-muted d-block ml-4">Khả năng tương thích cao</small>
                            </label>
                        </div>
                        <div class="custom-control custom-radio">
                            <input type="radio" id="formatPdf" name="exportFormat" class="custom-control-input" value="pdf">
                            <label class="custom-control-label" for="formatPdf">
                                <i class="fas fa-file-pdf text-danger mr-2"></i>PDF
                                <small class="text-muted d-block ml-4">Dễ xem và in ấn</small>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group mt-4">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="exportFilteredOnly">
                        <label class="custom-control-label" for="exportFilteredOnly">
                            Chỉ xuất dữ liệu theo bộ lọc hiện tại
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <a href="{% url 'dashboard:export_users' %}" class="btn btn-primary" id="exportDataBtn" target="_blank">
                    <i class="fas fa-download mr-1"></i> Xuất dữ liệu
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Thêm đoạn JavaScript này vào phần script ở cuối trang -->
<script>
// Thêm mã JavaScript để Việt hóa cột "Đăng nhập gần nhất"
$(document).ready(function() {
    // Việt hóa thời gian đăng nhập gần nhất
    $('.status-offline').each(function() {
        var timeText = $(this).text().trim();
        
        // Chuyển đổi "9 hours, 8 minutes trước" thành "9 giờ trước"
        if (timeText.includes('hours') || timeText.includes('hour')) {
            var hours = timeText.match(/\d+\s+hours?/)[0];
            var hourNum = hours.match(/\d+/)[0];
            $(this).text(hourNum + ' giờ trước');
        } 
        else if (timeText.includes('minutes') || timeText.includes('minute')) {
            var mins = timeText.match(/\d+\s+minutes?/)[0];
            var minNum = mins.match(/\d+/)[0];
            $(this).text(minNum + ' phút trước');
        }
        else if (timeText.includes('days') || timeText.includes('day')) {
            var days = timeText.match(/\d+\s+days?/)[0];
            var dayNum = days.match(/\d+/)[0];
            $(this).text(dayNum + ' ngày trước');
        }
        else if (timeText.includes('weeks') || timeText.includes('week')) {
            var weeks = timeText.match(/\d+\s+weeks?/)[0];
            var weekNum = weeks.match(/\d+/)[0];
            $(this).text(weekNum + ' tuần trước');
        }
        else if (timeText.includes('months') || timeText.includes('month')) {
            var months = timeText.match(/\d+\s+months?/)[0];
            var monthNum = months.match(/\d+/)[0];
            $(this).text(monthNum + ' tháng trước');
        }
        else if (timeText.includes('years') || timeText.includes('year')) {
            var years = timeText.match(/\d+\s+years?/)[0];
            var yearNum = years.match(/\d+/)[0];
            $(this).text(yearNum + ' năm trước');
        }
    });
    
    // Xử lý nút xóa người dùng
    $('.delete-user-btn').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var userId = $(this).data('user-id');
        var username = $(this).data('username');
        
        Swal.fire({
            title: 'Xác nhận xóa?',
            text: `Bạn có chắc chắn muốn xóa người dùng "${username}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/dashboard/users/${userId}/delete/`,
                    method: 'POST',
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        Swal.fire({
                            title: 'Đã xóa!',
                            text: `Người dùng "${username}" đã được xóa thành công.`,
                            icon: 'success'
                        }).then(() => {
                            window.location.reload();
                        });
                    },
                    error: function(error) {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Không thể xóa người dùng. Vui lòng thử lại sau.',
                            icon: 'error'
                        });
                    }
                });
            }
        });
    });
});
</script>

<!-- Sửa hiển thị số TCoin - chỉnh lại hiển thị trong phần users/list.html -->
<!-- Tìm đến phần hiển thị TCoin trong bảng và sửa thành -->
<td>{{ user.tcoin_balance|default_if_none:0|intcomma }}</td>

<!-- Thêm JavaScript này để xử lý nút xuất Excel -->
<script>
$(document).ready(function() {
    // Xử lý xuất Excel trực tiếp không qua modal
    $('#exportExcelBtn').off('click').on('click', function() {
        var format = 'xlsx'; // Định dạng mặc định
        // Gọi trực tiếp URL xuất Excel
        window.location.href = "{% url 'dashboard:export_users' %}?format=" + format;
    });
    
    // Cập nhật nút Export trong modal
    $('#exportDataBtn').off('click').on('click', function(e) {
        e.preventDefault();
        var format = $('input[name="exportFormat"]:checked').val() || 'xlsx';
        window.location.href = "{% url 'dashboard:export_users' %}?format=" + format;
    });
});
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script>
$(document).ready(function() {
    // Khởi tạo DateRangePicker
    $('.daterangepicker-input').daterangepicker({
        autoUpdateInput: false,
        locale: {
            cancelLabel: 'Xóa',
            applyLabel: 'Áp dụng',
            fromLabel: 'Từ',
            toLabel: 'Đến',
            customRangeLabel: 'Tùy chỉnh',
            daysOfWeek: ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'],
            monthNames: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6', 'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'],
            firstDay: 1
        }
    });

    $('.daterangepicker-input').on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
        filterTable();
    });

    $('.daterangepicker-input').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
        filterTable();
    });

    // Tìm kiếm realtime
    $('#searchInput').on('keyup', function() {
        filterTable();
    });
    
    // Xử lý các sự kiện thay đổi bộ lọc
    $('.filter-status, .filter-account-type, .filter-group, .filter-gender, .filter-activity').on('change', function() {
        filterTable();
    });
    
    // Xử lý sự kiện nhập số
    $('#balanceMin, #balanceMax, #tcoinMin, #tcoinMax').on('input', function() {
        filterTable();
    });
    
    // Xử lý sự kiện thay đổi sắp xếp
    $('#sortOption').on('change', function() {
        filterTable();
    });
    
    // Nút áp dụng bộ lọc
    $('#applyFilters').on('click', function() {
        filterTable();
    });
    
    // Nút đặt lại bộ lọc
    $('#resetFilters').on('click', function() {
        $('.filter-status, .filter-account-type, .filter-group, .filter-gender, .filter-activity').prop('checked', false);
        $('#joinDateRange, #balanceMin, #balanceMax, #tcoinMin, #tcoinMax').val('');
        $('#sortOption').val('username|asc');
        $('#searchInput').val('');
        filterTable();
    });

    // Hàm lọc bảng
    function filterTable() {
        var searchText = $('#searchInput').val().toLowerCase();
        var visibleCount = 0;
        
        // Thu thập các bộ lọc
        var statusFilters = $('.filter-status:checked').map(function() { return $(this).val(); }).get();
        var accountTypeFilters = $('.filter-account-type:checked').map(function() { return $(this).val(); }).get();
        var groupFilters = $('.filter-group:checked').map(function() { return $(this).val(); }).get();
        var genderFilters = $('.filter-gender:checked').map(function() { return $(this).val(); }).get();
        
        // Giá trị lọc số dư và TCoin
        var minBalance = $('#balanceMin').val() ? parseInt($('#balanceMin').val()) : null;
        var maxBalance = $('#balanceMax').val() ? parseInt($('#balanceMax').val()) : null;
        var minTCoin = $('#tcoinMin').val() ? parseInt($('#tcoinMin').val()) : null;
        var maxTCoin = $('#tcoinMax').val() ? parseInt($('#tcoinMax').val()) : null;
        
        // Giá trị lọc ngày tham gia
        var joinDateRange = $('#joinDateRange').val();
        var startDate = null;
        var endDate = null;
        if (joinDateRange) {
            var dates = joinDateRange.split(' - ');
            startDate = moment(dates[0], 'DD/MM/YYYY');
            endDate = moment(dates[1], 'DD/MM/YYYY');
        }
        
        // Lọc đã từng giao dịch và đã từng mua hàng
        var hasTransaction = $('#hasTransaction').is(':checked');
        var hasOrder = $('#hasOrder').is(':checked');
        
        // Lọc từng hàng
        $('#usersTable tbody tr').each(function() {
            var row = $(this);
            var rowText = row.text().toLowerCase();
            
            // Kiểm tra tìm kiếm
            var matchSearch = searchText === '' || rowText.indexOf(searchText) !== -1;
            
            // Kiểm tra trạng thái
            var matchStatus = true;
            if (statusFilters.length > 0) {
                var statusText = row.find('td:eq(3)').text().toLowerCase();
                matchStatus = statusFilters.some(function(status) {
                    if (status === 'active') return statusText.includes('hoạt động') && !statusText.includes('không');
                    if (status === 'inactive') return statusText.includes('không hoạt động');
                    if (status === 'pending') return statusText.includes('chờ xác nhận');
                    if (status === 'blocked') return statusText.includes('đã chặn');
                    return false;
                });
            }
            
            // Kiểm tra loại tài khoản
            var matchAccountType = true;
            if (accountTypeFilters.length > 0) {
                var accountText = row.find('td:eq(4)').text().toLowerCase();
                matchAccountType = accountTypeFilters.some(function(type) {
                    if (type === 'vip') return accountText.includes('vip');
                    if (type === 'premium') return accountText.includes('premium');
                    if (type === 'regular') return accountText.includes('thường');
                    return false;
                });
            }
            
            // Kiểm tra giới tính
            var matchGender = true;
            if (genderFilters.length > 0) {
                var gender = row.data('gender');
                matchGender = genderFilters.includes(gender);
            }
            
            // Kiểm tra ngày tham gia
            var matchJoinDate = true;
            if (startDate && endDate) {
                var joinDate = moment(row.data('join-date'));
                matchJoinDate = joinDate.isBetween(startDate, endDate, null, '[]');
            }
            
            // Kiểm tra số dư
            var matchBalance = true;
            if (minBalance !== null || maxBalance !== null) {
                var balanceText = row.find('td:eq(6)').text();
                var balance = parseInt(balanceText.replace(/[^\d]/g, '')) || 0;
                
                if (minBalance !== null) {
                    matchBalance = balance >= minBalance;
                }
                if (matchBalance && maxBalance !== null) {
                    matchBalance = balance <= maxBalance;
                }
            }
            
            // Kiểm tra TCoin
            var matchTCoin = true;
            if (minTCoin !== null || maxTCoin !== null) {
                var tcoin = parseInt(row.find('td:eq(7)').text().replace(/[^\d]/g, '')) || 0;
                
                if (minTCoin !== null) {
                    matchTCoin = tcoin >= minTCoin;
                }
                if (matchTCoin && maxTCoin !== null) {
                    matchTCoin = tcoin <= maxTCoin;
                }
            }
            
            // Kiểm tra đã từng giao dịch
            var matchTransaction = true;
            if (hasTransaction) {
                matchTransaction = (row.data('has-transactions') === true || row.data('has-transactions') === 'true');
            }
            
            // Kiểm tra đã từng mua hàng
            var matchOrder = true;
            if (hasOrder) {
                matchOrder = (row.data('has-orders') === true || row.data('has-orders') === 'true');
            }
            
            // Hiển thị hoặc ẩn hàng dựa trên kết quả lọc
            var showRow = matchSearch && matchStatus && matchAccountType && matchGender && 
                          matchJoinDate && matchBalance && matchTCoin && 
                          matchTransaction && matchOrder;
            
            row.toggle(showRow);
            if (showRow) visibleCount++;
        });
        
        // Cập nhật số lượng kết quả
        $('#resultCount').text(visibleCount);
        
        // Áp dụng sắp xếp
        sortTable();
    }
    
    // Hàm sắp xếp bảng
    function sortTable() {
        var sortOption = $('#sortOption').val();
        if (!sortOption) return;
        
        var sortParts = sortOption.split('|');
        var field = sortParts[0];
        var direction = sortParts[1];
        
        var rows = $('#usersTable tbody tr').get();
        
        rows.sort(function(a, b) {
            var A, B;
            
            // Xác định giá trị của cột cần sắp xếp
            switch (field) {
                case 'username':
                    A = $(a).find('td:eq(1)').text().trim().toLowerCase();
                    B = $(b).find('td:eq(1)').text().trim().toLowerCase();
                    break;
                case 'balance':
                    A = parseInt($(a).find('td:eq(6)').text().replace(/[^\d]/g, '')) || 0;
                    B = parseInt($(b).find('td:eq(6)').text().replace(/[^\d]/g, '')) || 0;
                    break;
                case 'tcoin':
                    A = parseInt($(a).find('td:eq(7)').text().replace(/[^\d]/g, '')) || 0;
                    B = parseInt($(b).find('td:eq(7)').text().replace(/[^\d]/g, '')) || 0;
                    break;
                case 'date_joined':
                    A = new Date($(a).data('join-date'));
                    B = new Date($(b).data('join-date'));
                    break;
                case 'last_login':
                    A = $(a).find('td:eq(8)').text().trim().toLowerCase();
                    B = $(b).find('td:eq(8)').text().trim().toLowerCase();
                    
                    // Xử lý đặc biệt cho "Online" và thời gian đăng nhập
                    if (A.includes('online')) A = new Date();
                    else if (A.includes('chưa đăng nhập')) A = new Date(0);
                    else A = new Date(Date.now() - parseTimeAgo(A));
                    
                    if (B.includes('online')) B = new Date();
                    else if (B.includes('chưa đăng nhập')) B = new Date(0);
                    else B = new Date(Date.now() - parseTimeAgo(B));
                    break;
                default:
                    A = $(a).find('td:eq(1)').text().trim().toLowerCase();
                    B = $(b).find('td:eq(1)').text().trim().toLowerCase();
            }
            
            // So sánh
            if (A < B) {
                return direction === 'asc' ? -1 : 1;
            }
            if (A > B) {
                return direction === 'asc' ? 1 : -1;
            }
            return 0;
        });
        
        // Thêm lại các hàng đã sắp xếp
        var tbody = $('#usersTable tbody');
        $.each(rows, function(index, row) {
            tbody.append(row);
        });
    }
    
    // Hàm phân tích chuỗi thời gian (ví dụ: "2 giờ trước" -> milliseconds)
    function parseTimeAgo(timeAgoStr) {
        var value = parseInt(timeAgoStr) || 0;
        var unit = timeAgoStr.toLowerCase();
        
        var milliseconds = 0;
        if (unit.includes('giây')) {
            milliseconds = value * 1000;
        } else if (unit.includes('phút')) {
            milliseconds = value * 60 * 1000;
        } else if (unit.includes('giờ')) {
            milliseconds = value * 60 * 60 * 1000;
        } else if (unit.includes('ngày')) {
            milliseconds = value * 24 * 60 * 60 * 1000;
        } else if (unit.includes('tuần')) {
            milliseconds = value * 7 * 24 * 60 * 60 * 1000;
        } else if (unit.includes('tháng')) {
            milliseconds = value * 30 * 24 * 60 * 60 * 1000;
        } else if (unit.includes('năm')) {
            milliseconds = value * 365 * 24 * 60 * 60 * 1000;
        }
        
        return milliseconds;
    }
    
    // Xử lý xuất dữ liệu đã lọc
    $('#exportFilteredOnly').on('change', function() {
        updateExportLinks();
    });
    
    // Cập nhật URL xuất dữ liệu
    function updateExportLinks() {
        var baseUrl = "{% url 'dashboard:export_users' %}";
        var onlyFiltered = $('#exportFilteredOnly').is(':checked');
        
        // Lấy định dạng đã chọn
        var selectedFormat = $('input[name="exportFormat"]:checked').val();
        
        // Tạo URL với tham số định dạng và bộ lọc
        var url = `${baseUrl}?format=${selectedFormat}`;
        
        if (onlyFiltered) {
            url += '&filtered=true';
            
            // Thêm các tham số lọc hiện tại nếu cần
            var activeFilters = getActiveFilters();
            
            if (activeFilters.search) {
                url += `&search=${encodeURIComponent(activeFilters.search)}`;
            }
            
            if (activeFilters.status.length > 0) {
                activeFilters.status.forEach(status => {
                    url += `&status=${encodeURIComponent(status)}`;
                });
            }
            
            if (activeFilters.accountType.length > 0) {
                activeFilters.accountType.forEach(type => {
                    url += `&accountType=${encodeURIComponent(type)}`;
                });
            }
            
            // Thêm các tham số lọc khác tương tự
        }
        
        // Cập nhật link cho button xuất dữ liệu
        $('#exportDataBtn').attr('href', url);
    }
    
    // Cập nhật khi thay đổi lựa chọn định dạng
    $('input[name="exportFormat"]').on('change', function() {
        updateExportLinks();
    });

    // Cập nhật khi thay đổi lựa chọn chỉ xuất dữ liệu đã lọc
    $('#exportFilteredOnly').on('change', function() {
        updateExportLinks();
    });
    
    // Lấy trạng thái hiện tại của tất cả bộ lọc
    function getActiveFilters() {
        return {
            search: $('#searchInput').val(),
            status: $('.filter-status:checked').map(function() { return $(this).val(); }).get(),
            accountType: $('.filter-account-type:checked').map(function() { return $(this).val(); }).get(),
            groups: $('.filter-group:checked').map(function() { return $(this).val(); }).get(),
            gender: $('.filter-gender:checked').map(function() { return $(this).val(); }).get(),
            joinDateStart: $('#joinDateRange').val() ? moment($('#joinDateRange').val().split(' - ')[0], 'DD/MM/YYYY').format('YYYY-MM-DD') : null,
            joinDateEnd: $('#joinDateRange').val() ? moment($('#joinDateRange').val().split(' - ')[1], 'DD/MM/YYYY').format('YYYY-MM-DD') : null,
            balanceMin: $('#balanceMin').val(),
            balanceMax: $('#balanceMax').val(),
            tcoinMin: $('#tcoinMin').val(),
            tcoinMax: $('#tcoinMax').val(),
            hasTransactions: $('#hasTransaction').is(':checked'),
            hasOrders: $('#hasOrder').is(':checked')
        };
    }
    
    // Xử lý modal xuất Excel
    $('#exportExcelBtn').on('click', function() {
        $('#exportModal').modal('show');
    });
    
    // Xử lý modal nhập Excel
    $('#importExcelBtn').on('click', function() {
        $('#importExcelModal').modal('show');
    });
    
    // Xử lý nút xóa người dùng
    $(document).on('click', '.delete-user-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var userId = $(this).data('user-id');
        var username = $(this).data('username');
        
        Swal.fire({
            title: 'Xác nhận xóa?',
            text: `Bạn có chắc chắn muốn xóa người dùng "${username}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                // Gửi request Ajax để xóa người dùng
                $.ajax({
                    url: `/dashboard/users/${userId}/delete/`,
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')  // Hàm lấy CSRF token
                    },
                    success: function(response) {
                        Swal.fire({
                            title: 'Đã xóa!',
                            text: `Người dùng "${username}" đã được xóa thành công.`,
                            icon: 'success'
                        }).then(() => {
                            // Làm mới trang
                            window.location.reload();
                        });
                    },
                    error: function(error) {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Không thể xóa người dùng. Vui lòng thử lại sau.',
                            icon: 'error'
                        });
                    }
                });
            }
        });
    });
    
    // Xử lý nút đặt lại mật khẩu
    $(document).on('click', '.reset-password-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var userId = $(this).data('user-id');
        var username = $(this).data('username');
        
        Swal.fire({
            title: 'Đặt lại mật khẩu?',
            text: `Bạn có chắc chắn muốn đặt lại mật khẩu cho "${username}"?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Đặt lại',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                // Gửi request Ajax để đặt lại mật khẩu
                $.ajax({
                    url: `/dashboard/users/${userId}/reset-password/`,
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')  // Hàm lấy CSRF token
                    },
                    success: function(response) {
                        Swal.fire({
                            title: 'Thành công!',
                            text: response.message || 'Mật khẩu đã được đặt lại thành công.',
                            icon: 'success',
                            html: response.password ? 
                                `Mật khẩu mới là: <strong>${response.password}</strong><br>Hãy lưu lại thông tin này.` : 
                                'Email đặt lại mật khẩu đã được gửi cho người dùng.'
                        });
                    },
                    error: function(error) {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Không thể đặt lại mật khẩu. Vui lòng thử lại sau.',
                            icon: 'error'
                        });
                    }
                });
            }
        });
    });
    
    // Hàm để lấy CSRF token từ cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Khởi tạo ban đầu
    filterTable();
    updateExportLinks();

    // Thêm mã JavaScript để Việt hóa cột "Đăng nhập gần nhất"
    $('.status-offline').each(function() {
        var timeText = $(this).text().trim();
        
        // Chuyển đổi "9 hours, 8 minutes trước" thành "9 giờ trước"
        if (timeText.includes('hours') || timeText.includes('hour')) {
            var hours = timeText.match(/\d+\s+hours?/)[0];
            var hourNum = hours.match(/\d+/)[0];
            $(this).text(hourNum + ' giờ trước');
        } 
        else if (timeText.includes('minutes') || timeText.includes('minute')) {
            var mins = timeText.match(/\d+\s+minutes?/)[0];
            var minNum = mins.match(/\d+/)[0];
            $(this).text(minNum + ' phút trước');
        }
        else if (timeText.includes('days') || timeText.includes('day')) {
            var days = timeText.match(/\d+\s+days?/)[0];
            var dayNum = days.match(/\d+/)[0];
            $(this).text(dayNum + ' ngày trước');
        }
        else if (timeText.includes('weeks') || timeText.includes('week')) {
            var weeks = timeText.match(/\d+\s+weeks?/)[0];
            var weekNum = weeks.match(/\d+/)[0];
            $(this).text(weekNum + ' tuần trước');
        }
        else if (timeText.includes('months') || timeText.includes('month')) {
            var months = timeText.match(/\d+\s+months?/)[0];
            var monthNum = months.match(/\d+/)[0];
            $(this).text(monthNum + ' tháng trước');
        }
        else if (timeText.includes('years') || timeText.includes('year')) {
            var years = timeText.match(/\d+\s+years?/)[0];
            var yearNum = years.match(/\d+/)[0];
            $(this).text(yearNum + ' năm trước');
        }
    });

    // Xử lý xuất Excel trực tiếp không qua modal
    $('#exportExcelBtn').off('click').on('click', function() {
        var format = 'xlsx'; // Định dạng mặc định
        // Gọi trực tiếp URL xuất Excel
        window.location.href = "{% url 'dashboard:export_users' %}?format=" + format;
    });
    
    // Cập nhật nút Export trong modal
    $('#exportDataBtn').off('click').on('click', function(e) {
        e.preventDefault();
        var format = $('input[name="exportFormat"]:checked').val() || 'xlsx';
        window.location.href = "{% url 'dashboard:export_users' %}?format=" + format;
    });
});
</script>
{% endblock %} 