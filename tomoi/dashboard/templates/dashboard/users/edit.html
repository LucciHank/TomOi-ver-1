{% extends 'dashboard/base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@x.x.x/dist/select2-bootstrap4.min.css" rel="stylesheet" />

<style>
    /* CSS cho avatar container và icon */
    .user-avatar-container {
        width: 150px;
        height: 150px;
        margin: 0 auto 20px;
        position: relative;
        transition: all 0.3s ease;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        overflow: visible;
    }
    
    .user-avatar {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 50%;
        border: 3px solid #4e73df;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .avatar-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #4e73df;
        color: white;
        font-size: 3rem;
        font-weight: bold;
        border-radius: 50%;
    }
    
    .avatar-upload {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: #fff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
        cursor: pointer;
        color: #4e73df;
        transition: all 0.3s ease;
        z-index: 5;
        border: 2px solid #4e73df;
    }
    
    .avatar-upload:hover {
        background-color: #4e73df;
        color: white;
        transform: scale(1.1);
    }
    
    .section-title {
        font-weight: 700;
        color: #4e73df;
        margin-bottom: 1.2rem;
        padding-bottom: 0.7rem;
        border-bottom: 2px solid #e3e6f0;
    }
    
    .form-card {
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        border: none;
        border-radius: 0.5rem;
        overflow: hidden;
        transition: all 0.3s;
    }
    
    .form-card:hover {
        box-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.25);
        transform: translateY(-5px);
    }
    
    .form-group label {
        font-weight: 600;
        color: #5a5c69;
    }
    
    .form-control {
        border-radius: 0.25rem;
        transition: all 0.2s;
    }
    
    .form-control:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    
    .btn {
        border-radius: 0.25rem;
        font-weight: 600;
        padding: 0.5rem 1.5rem;
        transition: all 0.3s;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    
    .btn-save {
        padding: 0.6rem 2rem;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .user-stats {
        background-color: #f8f9fc;
        border-radius: 0.5rem;
        padding: 1.2rem;
    }
    
    .stat-item {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e3e6f0;
        transition: all 0.3s;
    }
    
    .stat-item:hover {
        background-color: #f1f5fb;
        padding-left: 10px;
        border-radius: 0.3rem;
    }
    
    .stat-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .stat-label {
        color: #5a5c69;
        font-weight: 600;
        font-size: 0.8rem;
    }
    
    .stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: #4e73df;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #5a5c69;
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        transition: all 0.3s;
        border-bottom: 2px solid transparent;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: #e3e6f0;
        background-color: #f8f9fc;
    }
    
    .nav-tabs .nav-link.active {
        color: #4e73df;
        background-color: transparent;
        border-bottom: 2px solid #4e73df;
    }
    
    .card-header {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        font-weight: 700;
    }
    
    .badge {
        padding: 0.5em 0.8em;
        font-weight: 600;
    }
    
    .adjust-balance-card {
        background: linear-gradient(135deg, #1cc88a 0%, #169e6c 100%);
        color: white;
    }
    
    .adjust-tcoin-card {
        background: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
        color: white;
    }
    
    .reset-password-card {
        background: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
        color: white;
    }
    
    /* Custom Select2 Styling */
    .select2-container--bootstrap4 .select2-selection {
        height: calc(1.5em + 0.75rem + 2px);
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #6e707e;
        background-color: #fff;
        border: 1px solid #d1d3e2;
        border-radius: 0.35rem;
    }

    .select2-container--bootstrap4 .select2-selection--single .select2-selection__rendered {
        padding-left: 0;
        color: #6e707e;
        line-height: 1.5;
    }

    .select2-container--bootstrap4 .select2-selection--single .select2-selection__arrow {
        height: calc(1.5em + 0.75rem);
    }

    .select2-container--bootstrap4 .select2-results__option--highlighted[aria-selected] {
        background-color: #4e73df;
    }

    .select2-container--bootstrap4.select2-container--focus .select2-selection {
        border-color: #bac8f3;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    
    /* Thêm CSS cho tab bảo mật */
    .security-section {
        padding: 1.5rem;
        border-radius: 0.5rem;
        background-color: #f8f9fc;
        margin-bottom: 1rem;
        border-left: 4px solid #4e73df;
        transition: all 0.3s;
    }
    
    .security-section:hover {
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transform: translateY(-2px);
    }
    
    .security-title {
        font-weight: 600;
        color: #4e73df;
        margin-bottom: 0.7rem;
    }
    
    .security-active {
        background-color: #e3f9eb;
        border-left-color: #1cc88a;
    }
    
    .security-inactive {
        background-color: #feeceb;
        border-left-color: #e74a3b;
    }
    
    .security-warning {
        background-color: #fff8e6;
        border-left-color: #f6c23e;
    }
    
    /* Sửa các status badges */
    .badge-status-active {
        background-color: #1cc88a;
        color: white;
    }
    
    .badge-status-pending {
        background-color: #f6c23e;
        color: white;
    }
    
    .badge-status-suspended {
        background-color: #e74a3b;
        color: white;
    }
    
    /* Fix SweetAlert2 loading */
    .swal2-shown.swal2-height-auto {
        padding-right: 0 !important;
        height: 100% !important;
    }

    /* CSS cho combobox */
    .form-control {
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        color: #6e707e;
        background-color: #fff;
        border: 1px solid #d1d3e2;
        border-radius: 0.35rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    /* Căn giữa icon dropdown */
    select.form-control {
        padding-right: 2rem;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
    }

    /* Style cho modal */
    .modal-content {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }

    .modal-header {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    /* Style cho button group */
    .btn-group {
        gap: 0.5rem;
    }

    .btn-group .btn {
        border-radius: 0.35rem !important;
        padding: 0.5rem;
        flex: 1;
    }

    /* Style cho form groups */
    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        font-weight: 600;
        color: #4e73df;
        margin-bottom: 0.5rem;
    }

    /* Đồng bộ style cho cả hai form */
    #balanceForm, #tcoinForm {
        .form-control {
            margin-bottom: 1rem;
        }
        
        textarea {
            resize: none;
        }
    }

    .current-balance, .current-tcoin {
        background-color: #f8f9fc;
        border: 1px solid #e3e6f0;
    }

    .input-group-text {
        background-color: #f8f9fc;
        border-color: #d1d3e2;
    }

    /* Style chung cho modal */
    .modal-content {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }

    .modal-header {
        border-bottom: none;
        padding: 1.5rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    /* Style cho số dư/tcoin hiện tại */
    .current-balance, .current-tcoin {
        background: linear-gradient(to right, #4e73df, #224abe);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11);
    }

    .current-tcoin {
        background: linear-gradient(to right, #f6c23e, #f4b619);
        color: white;
    }

    .balance-amount, .tcoin-amount {
        font-size: 2rem;
        font-weight: 700;
        display: block;
    }

    /* Style cho nhóm nút điều chỉnh */
    .adjust-type-group {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .adjust-type-btn {
        padding: 0.5rem;
        border-radius: 0.35rem;
        font-weight: 600;
        width: 100%;
    }

    .adjust-type-btn.active {
        transform: translateY(2px);
    }

    /* Style cho form groups */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 0.5rem;
    }

    .form-control {
        border-radius: 0.35rem;
        border: 1px solid #d1d3e2;
        padding: 0.75rem;
    }

    .input-group-text {
        background-color: #f8f9fc;
        border-color: #d1d3e2;
        color: #5a5c69;
    }

    /* Style cho buttons */
    .btn {
        padding: 0.5rem 1.5rem;
        font-weight: 600;
        border-radius: 0.35rem;
    }

    .modal-footer {
        border-top: none;
        padding: 1rem 1.5rem;
    }

    /* Fix cho button active */
    .btn-outline-success.active {
        background-color: #1cc88a;
        color: white;
    }

    .btn-outline-danger.active {
        background-color: #e74a3b;
        color: white;
    }

    .btn-outline-primary.active {
        background-color: #4e73df;
        color: white;
    }

    /* Fix cho combobox bị cắt phần chân chữ */
    select {
        height: auto !important;
        padding-top: 8px !important;
        padding-bottom: 8px !important;
        line-height: 1.5 !important;
    }
    
    /* Các style đã có trước đó */
    .form-card {
        border-radius: 10px;
    }
    
    .form-card .card-header {
        border-radius: 10px 10px 0 0;
        font-weight: bold;
    }
    
    .user-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .avatar-placeholder {
        width: 100px;
        height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 2.5rem;
        border-radius: 50%;
        background-color: #4e73df;
    }
    
    .current-balance, .current-tcoin {
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .adjust-balance-card {
        background: linear-gradient(to right, #4e73df, #224abe);
        color: white;
    }
    
    .adjust-tcoin-card {
        background: linear-gradient(to right, #f6c23e, #dda20a);
        color: white;
    }
    
    .btn-check {
        position: absolute;
        clip: rect(0, 0, 0, 0);
        pointer-events: none;
    }
    
    .btn-check:checked + .btn-outline-success {
        color: #fff;
        background-color: #1cc88a;
        border-color: #1cc88a;
    }
    
    .btn-check:checked + .btn-outline-danger {
        color: #fff;
        background-color: #e74a3b;
        border-color: #e74a3b;
    }
    
    .btn-check:checked + .btn-outline-primary {
        color: #fff;
        background-color: #4e73df;
        border-color: #4e73df;
    }

    /* Ẩn radio button nhưng vẫn giữ chức năng */
    .form-check-input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    /* Điều chỉnh thiết kế cho hiển thị số dư và TCoin */
    .current-balance {
        background: linear-gradient(to right, #4e73df, #224abe);
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11);
    }
    
    .current-tcoin {
        background: linear-gradient(to right, #f6c23e, #f4b619);
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11);
    }
    
    /* Icon TCoin */
    .tcoin-icon {
        width: 18px;
        height: 18px;
        margin-bottom: 3px;
    }
    
    .tcoin-icon-lg {
        width: 30px;
        height: 30px;
    }
    
    .tcoin-icon-sm {
        width: 20px;
        height: 20px;
    }
    
    /* Điều chỉnh chiều cao input và đơn vị */
    .input-lg {
        height: 50px;
        font-size: 1.1rem;
    }
    
    .input-lg-text {
        height: 50px !important;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        padding-top: 0;
        padding-bottom: 0;
    }
    
    /* Đồng bộ màu sắc nút với theme */
    #adjustBalanceBtn {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    #adjustTCoinBtn {
        background-color: #f6c23e;
        border-color: #f6c23e;
    }
    
    /* CSS cho 2FA Settings */
    .password-2fa-options {
        display: none;
    }
    
    .password-2fa-options.show {
        display: block;
    }
    
    .balance-tcoin-row {
        display: flex;
        gap: 20px;
    }
    
    .balance-tcoin-row .card {
        flex: 1;
    }
</style>
{% endblock %}

{% block title %}Chỉnh sửa người dùng{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 text-gray-800">Chỉnh sửa người dùng: <span class="text-primary">{{ user.username }}</span></h1>
                <div>
                    <a href="{% url 'dashboard:user_list' %}" class="btn btn-secondary mr-2">
                        <i class="fas fa-arrow-left mr-1"></i> Quay lại
                    </a>
                    <a href="{% url 'dashboard:user_permissions' user.id %}" class="btn btn-primary mr-2">
                        <i class="fas fa-user-shield mr-1"></i> Phân quyền
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Cột bên trái - Thông tin tài khoản và avatar -->
        <div class="col-lg-4">
            <!-- Thông tin tài khoản -->
            <div class="card form-card shadow mb-4">
                <div class="card-header py-3 bg-gradient-primary text-white">
                    <h6 class="m-0 font-weight-bold">Thông tin tài khoản</h6>
                </div>
                <div class="card-body">
                    <!-- Thay đổi phần xử lý form avatar -->
                    <form id="avatarUploadForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="avatar_form">
                        <div class="user-avatar-container mb-4">
                            {% if user.avatar %}
                                <img src="{{ user.avatar.url }}" alt="{{ user.username }}" class="user-avatar">
                            {% else %}
                                <div class="avatar-placeholder">{{ user.username|make_list|first|upper }}</div>
                            {% endif %}
                            <label for="avatar" class="avatar-upload">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" name="avatar" id="avatar" style="display:none" accept="image/*">
                        </div>
                        <div class="text-center mb-3">
                            <button type="submit" class="btn btn-sm btn-primary">
                                <i class="fas fa-upload mr-1"></i> Cập nhật avatar
                            </button>
                        </div>
                    </form>
                
                    <div class="user-stats">
                        <div class="stat-item">
                            <div class="stat-label">Số dư</div>
                            <div class="stat-value">{{ user.balance|default:'0'|intcomma }}đ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">TCoin</div>
                            <div class="stat-value">{{ user.tcoin_balance|default:'0'|intcomma }} <img src="{% static 'images/tcoin.png' %}" alt="TCoin" class="tcoin-icon"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Ngày tham gia</div>
                            <div class="stat-value">{{ user.date_joined|date:"d/m/Y" }}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Đăng nhập gần nhất</div>
                            <div class="stat-value">
                                {% if user.last_login %}
                                {{ user.last_login|date:"d/m/Y H:i" }}
                                {% else %}
                                Chưa đăng nhập
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Card đặt lại mật khẩu -->
            <div class="card form-card shadow mb-4">
                <div class="card-header py-3 reset-password-card">
                    <h6 class="m-0 font-weight-bold">Đặt lại mật khẩu</h6>
                </div>
                <div class="card-body">
                    <form id="resetPasswordForm">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_new_password">Mật khẩu mới</label>
                                    <input type="password" class="form-control" id="id_new_password" name="new_password" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_confirm_password">Xác nhận mật khẩu</label>
                                    <input type="password" class="form-control" id="id_confirm_password" name="confirm_password" required>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-key mr-2"></i>Đặt lại mật khẩu
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Cột giữa - Thông tin cá nhân -->
        <div class="col-lg-4">
            <!-- Thông tin cơ bản -->
            <div class="card form-card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center bg-gradient-primary text-white">
                    <h6 class="m-0 font-weight-bold">Thông tin cá nhân</h6>
                    <span class="badge badge-light">ID: {{ user.id }}</span>
                </div>
                <div class="card-body">
                    <!-- Thêm form_type vào form chính -->
                    <form id="userEditForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="user_edit_form">
                        
                        <ul class="nav nav-tabs mb-3" id="userInfoTabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="basic-tab" data-toggle="tab" href="#basic" role="tab">
                                    <i class="fas fa-user mr-1"></i> Cơ bản
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab">
                                    <i class="fas fa-address-card mr-1"></i> Liên hệ
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="bank-tab" data-toggle="tab" href="#bank" role="tab">
                                    <i class="fas fa-university mr-1"></i> Thanh toán
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="security-tab" data-toggle="tab" href="#security" role="tab">
                                    <i class="fas fa-lock mr-1"></i> Bảo mật
                                </a>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="userInfoTabsContent">
                            <!-- Tab thông tin cơ bản -->
                            <div class="tab-pane fade show active" id="basic" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_username">Tên đăng nhập <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="id_username" name="username" value="{{ user.username }}" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="id_email">Email <span class="text-danger">*</span></label>
                                            <input type="email" class="form-control" id="id_email" name="email" value="{{ user.email }}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_first_name">Họ</label>
                                            <input type="text" class="form-control" id="id_first_name" name="first_name" value="{{ user.first_name }}">
                                        </div>
                                        <div class="form-group">
                                            <label for="id_last_name">Tên</label>
                                            <input type="text" class="form-control" id="id_last_name" name="last_name" value="{{ user.last_name }}">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_gender">Giới tính</label>
                                            <select class="form-control select2" id="id_gender" name="gender">
                                                <option value="male" {% if user.gender == 'male' %}selected{% endif %}>Nam</option>
                                                <option value="female" {% if user.gender == 'female' %}selected{% endif %}>Nữ</option>
                                                <option value="other" {% if user.gender == 'other' %}selected{% endif %}>Khác</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="id_birth_date">Ngày sinh</label>
                                            <input type="date" class="form-control" id="id_birth_date" name="birth_date" value="{{ user.birth_date|date:'Y-m-d' }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_account_type">Loại tài khoản</label>
                                            <select class="form-control select2" id="id_account_type" name="account_type">
                                                <option value="regular" {% if user.account_type == 'regular' %}selected{% endif %}>Thường</option>
                                                <option value="premium" {% if user.account_type == 'premium' %}selected{% endif %}>Premium</option>
                                                <option value="vip" {% if user.account_type == 'vip' %}selected{% endif %}>VIP</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="id_user_type">Vai trò</label>
                                            <select class="form-control select2" id="id_user_type" name="user_type">
                                                <option value="customer" {% if user.user_type == 'customer' %}selected{% endif %}>Khách hàng</option>
                                                <option value="staff" {% if user.user_type == 'staff' %}selected{% endif %}>Nhân viên</option>
                                                <option value="admin" {% if user.user_type == 'admin' %}selected{% endif %}>Admin</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="id_bio">Giới thiệu</label>
                                    <textarea class="form-control" id="id_bio" name="bio" rows="3">{{ user.bio }}</textarea>
                                </div>
                            </div>
                            
                            <!-- Tab thông tin liên hệ -->
                            <div class="tab-pane fade" id="contact" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_phone">Số điện thoại</label>
                                            <input type="tel" class="form-control" id="id_phone" name="phone" value="{{ user.phone }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_country">Quốc gia</label>
                                            <select class="form-control select2" id="id_country" name="country">
                                                <option value="">-- Chọn quốc gia --</option>
                                                <option value="VN" {% if user.country == 'VN' %}selected{% endif %}>Việt Nam</option>
                                                <option value="US" {% if user.country == 'US' %}selected{% endif %}>Hoa Kỳ</option>
                                                <option value="GB" {% if user.country == 'GB' %}selected{% endif %}>Vương quốc Anh</option>
                                                <option value="JP" {% if user.country == 'JP' %}selected{% endif %}>Nhật Bản</option>
                                                <option value="KR" {% if user.country == 'KR' %}selected{% endif %}>Hàn Quốc</option>
                                                <option value="SG" {% if user.country == 'SG' %}selected{% endif %}>Singapore</option>
                                                <option value="MY" {% if user.country == 'MY' %}selected{% endif %}>Malaysia</option>
                                                <option value="TH" {% if user.country == 'TH' %}selected{% endif %}>Thái Lan</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="id_address">Địa chỉ</label>
                                    <input type="text" class="form-control" id="id_address" name="address" value="{{ user.address }}">
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_city">Thành phố</label>
                                            <input type="text" class="form-control" id="id_city" name="city" value="{{ user.city }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_postal_code">Mã bưu chính</label>
                                            <input type="text" class="form-control" id="id_postal_code" name="postal_code" value="{{ user.postal_code }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tab thông tin ngân hàng -->
                            <div class="tab-pane fade" id="bank" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_bank_name">Tên ngân hàng</label>
                                            <select class="form-control select2" id="id_bank_name" name="bank_name">
                                                <option value="">-- Chọn ngân hàng --</option>
                                                <option value="VCB" {% if user.bank_name == 'VCB' %}selected{% endif %}>Vietcombank</option>
                                                <option value="BIDV" {% if user.bank_name == 'BIDV' %}selected{% endif %}>BIDV</option>
                                                <option value="TCB" {% if user.bank_name == 'TCB' %}selected{% endif %}>Techcombank</option>
                                                <option value="ACB" {% if user.bank_name == 'ACB' %}selected{% endif %}>ACB</option>
                                                <option value="VIB" {% if user.bank_name == 'VIB' %}selected{% endif %}>VIB</option>
                                                <option value="VTB" {% if user.bank_name == 'VTB' %}selected{% endif %}>VietinBank</option>
                                                <option value="MB" {% if user.bank_name == 'MB' %}selected{% endif %}>MB Bank</option>
                                                <option value="TPB" {% if user.bank_name == 'TPB' %}selected{% endif %}>TPBank</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_bank_branch">Chi nhánh</label>
                                            <input type="text" class="form-control" id="id_bank_branch" name="bank_branch" value="{{ user.bank_branch }}">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_bank_account_number">Số tài khoản</label>
                                            <input type="text" class="form-control" id="id_bank_account_number" name="bank_account_number" value="{{ user.bank_account_number }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="id_bank_account_name">Tên chủ tài khoản</label>
                                            <input type="text" class="form-control" id="id_bank_account_name" name="bank_account_name" value="{{ user.bank_account_name }}">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="id_payment_methods">Phương thức thanh toán</label>
                                    <select class="form-control select2" id="id_payment_methods" name="payment_methods" multiple>
                                        <option value="bank_transfer" {% if 'bank_transfer' in user.payment_methods %}selected{% endif %}>Chuyển khoản ngân hàng</option>
                                        <option value="credit_card" {% if 'credit_card' in user.payment_methods %}selected{% endif %}>Thẻ tín dụng</option>
                                        <option value="momo" {% if 'momo' in user.payment_methods %}selected{% endif %}>Ví MoMo</option>
                                        <option value="zalopay" {% if 'zalopay' in user.payment_methods %}selected{% endif %}>ZaloPay</option>
                                        <option value="vnpay" {% if 'vnpay' in user.payment_methods %}selected{% endif %}>VNPay</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Tab bảo mật -->
                            <div class="tab-pane fade" id="security" role="tabpanel">
                                <h5 class="security-title">Trạng thái tài khoản</h5>
                                <div class="form-group">
                                    <label for="id_is_active">Trạng thái</label>
                                    <select class="form-control select2" id="id_is_active" name="is_active">
                                        <option value="true" {% if user.is_active %}selected{% endif %}>Hoạt động</option>
                                        <option value="false" {% if not user.is_active %}selected{% endif %}>Tạm khóa</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="id_account_status">Tình trạng</label>
                                    <select class="form-control select2" id="id_account_status" name="account_status">
                                        <option value="active" {% if user.account_status == 'active' %}selected{% endif %}>Hoạt động</option>
                                        <option value="pending" {% if user.account_status == 'pending' %}selected{% endif %}>Chờ xác minh</option>
                                        <option value="suspended" {% if user.account_status == 'suspended' %}selected{% endif %}>Tạm ngưng</option>
                                        <option value="banned" {% if user.account_status == 'banned' %}selected{% endif %}>Cấm vĩnh viễn</option>
                                    </select>
                                </div>
                                
                                <hr>
                                
                                <h5 class="security-title">Xác minh hai yếu tố (2FA)</h5>
                                <div class="security-section {% if user.has_2fa %}security-active{% else %}security-inactive{% endif %}">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <h6 class="mb-1">Tình trạng 2FA</h6>
                                            <p class="mb-0 small">
                                                {% if user.has_2fa %}
                                                <span class="text-success"><i class="fas fa-check-circle"></i> Đã kích hoạt</span>
                                                {% else %}
                                                <span class="text-danger"><i class="fas fa-times-circle"></i> Chưa kích hoạt</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="id_has_2fa" name="has_2fa" {% if user.has_2fa %}checked{% endif %}>
                                            <label class="form-check-label" for="id_has_2fa"></label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="id_two_factor_method">Phương thức xác thực</label>
                                        <select class="form-control select2" id="id_two_factor_method" name="two_factor_method">
                                            <option value="">Không sử dụng</option>
                                            <option value="password" {% if user.two_factor_method == 'password' %}selected{% endif %}>Mật khẩu xác thực</option>
                                            <option value="email" {% if user.two_factor_method == 'email' %}selected{% endif %}>Email OTP</option>
                                            <option value="google" {% if user.two_factor_method == 'google' %}selected{% endif %}>Google Authenticator</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Tùy chọn 2FA cho mật khẩu -->
                                    <div id="password2faOptions" class="password-2fa-options {% if user.two_factor_method == 'password' %}show{% endif %}">
                                        <div class="form-group">
                                            <label for="id_2fa_password">Mật khẩu xác thực</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="id_2fa_password" name="two_factor_password">
                                                <div class="input-group-append">
                                                    <button class="btn btn-outline-secondary" type="button" id="generatePassword">
                                                        <i class="fas fa-sync-alt"></i> Tạo mới
                                                    </button>
                                                </div>
                                            </div>
                                            <small class="form-text text-muted">Mật khẩu dùng để xác thực khi người dùng thực hiện các giao dịch quan trọng.</small>
                                        </div>
                                    </div>
                                    
                                    <!-- Tùy chọn 2FA cho email -->
                                    <div id="email2faOptions" class="password-2fa-options {% if user.two_factor_method == 'email' %}show{% endif %}">
                                        <div class="form-group">
                                            <label for="id_2fa_email">Email xác thực</label>
                                            <input type="email" class="form-control" id="id_2fa_email" name="two_factor_email" value="{{ user.email }}">
                                            <small class="form-text text-muted">Mã OTP sẽ được gửi đến email này khi cần xác thực.</small>
                                        </div>
                                    </div>
                                    
                                    <!-- Tùy chọn 2FA cho Google Authenticator -->
                                    <div id="google2faOptions" class="password-2fa-options {% if user.two_factor_method == 'google' %}show{% endif %}">
                                        <div class="form-group">
                                            <label for="id_ga_secret_key">Mã bí mật Google Authenticator</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="id_ga_secret_key" name="ga_secret_key" value="{{ user.ga_secret_key }}" readonly>
                                                <div class="input-group-append">
                                                    <button class="btn btn-outline-secondary" type="button" id="generateGAKey">
                                                        <i class="fas fa-sync-alt"></i> Tạo mới
                                                    </button>
                                                </div>
                                            </div>
                                            <small class="form-text text-muted">Mã bí mật dùng để thiết lập Google Authenticator.</small>
                                        </div>
                                        
                                        {% if user.ga_secret_key %}
                                        <div class="text-center mb-3">
                                            <img id="gaQrCode" src="https://chart.googleapis.com/chart?chs=200x200&chld=M|0&cht=qr&chl=otpauth://totp/{{ user.email }}?secret={{ user.ga_secret_key }}&issuer=TomOi" class="img-fluid border rounded" alt="QR Code">
                                            <p class="small text-muted mt-2">Quét mã QR với ứng dụng Google Authenticator</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <h5 class="security-title">Yêu cầu xác minh hai yếu tố</h5>
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" id="id_require_2fa" name="require_2fa" {% if user.require_2fa %}checked{% endif %}>
                                        <label class="custom-control-label" for="id_require_2fa">Yêu cầu 2FA cho tất cả hành động quan trọng</label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Yêu cầu 2FA cho:</label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="id_require_2fa_login" name="require_2fa_login" {% if user.require_2fa_login %}checked{% endif %}>
                                                <label class="custom-control-label" for="id_require_2fa_login">Đăng nhập</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mt-2">
                                                <input type="checkbox" class="custom-control-input" id="id_require_2fa_payment" name="require_2fa_payment" {% if user.require_2fa_payment %}checked{% endif %}>
                                                <label class="custom-control-label" for="id_require_2fa_payment">Thanh toán</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="id_require_2fa_profile" name="require_2fa_profile" {% if user.require_2fa_profile %}checked{% endif %}>
                                                <label class="custom-control-label" for="id_require_2fa_profile">Thay đổi thông tin cá nhân</label>
                                            </div>
                                            <div class="custom-control custom-checkbox mt-2">
                                                <input type="checkbox" class="custom-control-input" id="id_require_2fa_withdraw" name="require_2fa_withdraw" {% if user.require_2fa_withdraw %}checked{% endif %}>
                                                <label class="custom-control-label" for="id_require_2fa_withdraw">Rút tiền</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-save">
                                <i class="fas fa-save mr-2"></i> Lưu thay đổi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Cột bên phải - Công cụ và điều chỉnh TCoin -->
        <div class="col-lg-4">
            <!-- Điều chỉnh số dư -->
            <div class="card form-card shadow mb-4">
                <div class="card-header py-3 adjust-balance-card bg-gradient-primary text-white">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-money-bill-wave mr-2"></i> Điều chỉnh số dư</h6>
                </div>
                <div class="card-body">
                    <form id="balanceForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="font-weight-bold text-primary">Số dư hiện tại</label>
                            <div class="current-balance p-3 rounded mb-3 text-center">
                                <span class="h3 mb-0 font-weight-bold text-white">{{ user.balance|default:'0'|intcomma }}đ</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="font-weight-bold text-primary">Loại điều chỉnh</label>
                            <div class="adjust-type-container d-flex mb-3">
                                <div class="form-check form-check-inline flex-fill">
                                    <input class="form-check-input" type="radio" name="adjustType" id="btnAdd" value="add" checked>
                                    <label class="form-check-label btn btn-outline-success w-100 py-2" for="btnAdd">
                                        <i class="fas fa-plus-circle mr-1"></i> Cộng tiền
                                    </label>
                                </div>
                                
                                <div class="form-check form-check-inline flex-fill">
                                    <input class="form-check-input" type="radio" name="adjustType" id="btnSubtract" value="subtract">
                                    <label class="form-check-label btn btn-outline-danger w-100 py-2" for="btnSubtract">
                                        <i class="fas fa-minus-circle mr-1"></i> Trừ tiền
                                    </label>
                                </div>
                                
                                <div class="form-check form-check-inline flex-fill">
                                    <input class="form-check-input" type="radio" name="adjustType" id="btnSet" value="set">
                                    <label class="form-check-label btn btn-outline-primary w-100 py-2" for="btnSet">
                                        <i class="fas fa-edit mr-1"></i> Đặt số dư
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="font-weight-bold text-primary">Số tiền</label>
                            <div class="input-group mb-3">
                                <input type="text" name="amount" class="form-control form-control-lg text-right input-lg" required placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-primary text-white input-lg-text">VNĐ</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="font-weight-bold text-primary">Lý do điều chỉnh</label>
                            <textarea name="reason" class="form-control" rows="3" placeholder="Nhập lý do điều chỉnh..."></textarea>
                            <small class="form-text text-muted">Vui lòng cung cấp lý do để dễ dàng theo dõi trong lịch sử.</small>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="button" id="adjustBalanceBtn" class="btn btn-primary btn-lg px-5 d-flex align-items-center mx-auto">
                                <i class="fas fa-save mr-2"></i> Cập nhật số dư
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Điều chỉnh TCoin -->
            <div class="card form-card shadow mb-4">
                <div class="card-header py-3 adjust-tcoin-card bg-gradient-warning text-white">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-coins mr-2"></i> Điều chỉnh TCoin</h6>
                </div>
                <div class="card-body">
                    <form id="tcoinForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="font-weight-bold text-warning">TCoin hiện tại</label>
                            <div class="current-tcoin p-3 rounded mb-3 text-center">
                                <div class="d-flex justify-content-center align-items-center">
                                    <span class="h3 mb-0 font-weight-bold text-white">{{ user.tcoin_balance|default:'0'|intcomma }}</span>
                                    <img src="{% static 'images/tcoin.png' %}" alt="TCoin" class="tcoin-icon-lg ml-2">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="font-weight-bold text-warning">Loại điều chỉnh</label>
                            <div class="adjust-type-container d-flex mb-3">
                                <div class="form-check form-check-inline flex-fill">
                                    <input class="form-check-input" type="radio" name="tcoinAdjustType" id="tcoinAdd" value="add" checked>
                                    <label class="form-check-label btn btn-outline-success w-100 py-2" for="tcoinAdd">
                                        <i class="fas fa-plus-circle mr-1"></i> Cộng TCoin
                                    </label>
                                </div>
                                
                                <div class="form-check form-check-inline flex-fill">
                                    <input class="form-check-input" type="radio" name="tcoinAdjustType" id="tcoinSubtract" value="subtract">
                                    <label class="form-check-label btn btn-outline-danger w-100 py-2" for="tcoinSubtract">
                                        <i class="fas fa-minus-circle mr-1"></i> Trừ TCoin
                                    </label>
                                </div>
                                
                                <div class="form-check form-check-inline flex-fill">
                                    <input class="form-check-input" type="radio" name="tcoinAdjustType" id="tcoinSet" value="set">
                                    <label class="form-check-label btn btn-outline-primary w-100 py-2" for="tcoinSet">
                                        <i class="fas fa-edit mr-1"></i> Đặt số TCoin
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="font-weight-bold text-warning">Số lượng TCoin</label>
                            <div class="input-group mb-3">
                                <input type="text" name="amount" class="form-control form-control-lg text-right input-lg" required placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text bg-warning text-white input-lg-text d-flex align-items-center">
                                        <img src="{% static 'images/tcoin.png' %}" alt="TCoin" class="tcoin-icon-sm">
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="font-weight-bold text-warning">Lý do điều chỉnh</label>
                            <textarea name="reason" class="form-control" rows="3" placeholder="Nhập lý do điều chỉnh..."></textarea>
                            <small class="form-text text-muted">Vui lòng cung cấp lý do để dễ dàng theo dõi trong lịch sử.</small>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="button" id="adjustTCoinBtn" class="btn btn-warning btn-lg px-5 text-white d-flex align-items-center mx-auto">
                                <i class="fas fa-save mr-2"></i> Cập nhật TCoin
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS bổ sung cho trang edit user -->
<style>
    /* Điều chỉnh thiết kế cho hiển thị số dư và TCoin */
    .current-balance {
        background: linear-gradient(to right, #4e73df, #224abe);
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11);
    }
    
    .current-tcoin {
        background: linear-gradient(to right, #f6c23e, #f4b619);
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11);
    }
    
    /* Icon TCoin */
    .tcoin-icon {
        width: 18px;
        height: 18px;
        margin-bottom: 3px;
    }
    
    .tcoin-icon-lg {
        width: 30px;
        height: 30px;
    }
    
    .tcoin-icon-sm {
        width: 20px;
        height: 20px;
    }
    
    /* Điều chỉnh chiều cao input và đơn vị */
    .input-lg {
        height: 50px;
        font-size: 1.1rem;
    }
    
    .input-lg-text {
        height: 50px !important;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        padding-top: 0;
        padding-bottom: 0;
    }
    
    /* Đồng bộ màu sắc nút với theme */
    #adjustBalanceBtn {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    #adjustTCoinBtn {
        background-color: #f6c23e;
        border-color: #f6c23e;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Tải SweetAlert2 đúng cách -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    // Kiểm tra SweetAlert2 đã được tải chưa
    if (typeof Swal === 'undefined') {
        console.error('SweetAlert2 is not loaded. Loading it now...');
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
        document.head.appendChild(script);
    }
    
    // Khởi tạo Select2 với theme bootstrap4
    $('.select2').select2({
        theme: 'bootstrap4',
        width: '100%',
        placeholder: 'Chọn...',
        allowClear: true
    });
    
    // Xử lý xem trước ảnh avatar
    $('#avatar').on('change', function() {
        var file = this.files[0];
        if (file) {
            // Hiển thị preview
            var reader = new FileReader();
            reader.onload = function(e) {
                $('.avatar-placeholder').hide();
                if ($('.user-avatar').length) {
                    $('.user-avatar').attr('src', e.target.result);
                } else {
                    $('.user-avatar-container').prepend('<img src="' + e.target.result + '" alt="Preview" class="user-avatar">');
                }
            };
            reader.readAsDataURL(file);
            
            // Tự động upload avatar
            var formData = new FormData($('#avatarUploadForm')[0]);
            
            // Debug thông tin form
            console.log('Avatar form data:', Object.fromEntries(formData));
            
            // Hiển thị loading
            Swal.fire({
                title: 'Đang tải lên...',
                text: 'Vui lòng đợi trong giây lát',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Gửi request
            $.ajax({
                url: '{% url "dashboard:user_edit" user.id %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log('Avatar upload success:', response);
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công',
                        text: 'Avatar đã được cập nhật!',
                        confirmButtonColor: '#4e73df'
                    }).then(() => {
                        location.reload(); // Reload để hiển thị avatar mới
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Avatar upload error:', {xhr, status, error});
                    let errorMessage = 'Không thể cập nhật avatar.';
                    
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.message || response.error || errorMessage;
                    } catch (e) {
                        if (xhr.responseText && xhr.responseText.length < 200) {
                            errorMessage = xhr.responseText;
                        }
                    }
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: errorMessage,
                        confirmButtonColor: '#4e73df'
                    });
                }
            });
        }
    });
    
    // Xử lý submit form cập nhật thông tin
    $('#userEditForm').on('submit', function(e) {
        e.preventDefault();
        
        // Tạo FormData từ form
        var formData = new FormData(this);
        
        // Debug: In ra thông tin form trước khi xử lý
        console.log('Form data before processing:', Object.fromEntries(formData));
        
        // Đảm bảo form_type được gửi đúng
        formData.set('form_type', 'user_edit_form');
        
        // Xử lý các checkbox 2FA
        const checkboxFields = [
            'has_2fa', 'require_2fa', 'require_2fa_login', 
            'require_2fa_payment', 'require_2fa_profile', 
            'require_2fa_withdraw'
        ];
        
        checkboxFields.forEach(field => {
            if (!formData.has(field)) {
                formData.append(field, 'false');
            } else {
                formData.set(field, 'true');
            }
        });
        
        // Xử lý đặc biệt cho trường is_active
        formData.set('is_active', $('#id_is_active').val() === 'true' ? 'true' : 'false');
        
        // Xử lý 2FA method và has_2fa
        const twoFactorMethod = formData.get('two_factor_method');
        if (twoFactorMethod && twoFactorMethod !== '') {
            formData.set('has_2fa', 'true');
            
            // Xử lý mật khẩu 2FA nếu phương thức là password
            if (twoFactorMethod === 'password' && $('#id_2fa_password').val()) {
                formData.set('two_factor_password', $('#id_2fa_password').val());
            }
            
            // Xử lý email 2FA nếu phương thức là email
            if (twoFactorMethod === 'email' && $('#id_2fa_email').val()) {
                formData.set('two_factor_email', $('#id_2fa_email').val());
            }
            
            // Xử lý Google Authenticator nếu phương thức là google
            if (twoFactorMethod === 'google' && $('#id_ga_secret_key').val()) {
                formData.set('ga_secret_key', $('#id_ga_secret_key').val());
            }
        } else {
            formData.set('has_2fa', 'false');
            formData.set('two_factor_method', '');
        }
        
        // Debug: In ra thông tin form sau khi xử lý
        console.log('Form data after processing:', Object.fromEntries(formData));
        
        // Hiển thị loading
        Swal.fire({
            title: 'Đang xử lý...',
            text: 'Vui lòng đợi trong giây lát',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Gửi request
        $.ajax({
            url: '{% url "dashboard:user_edit" user.id %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                console.log('Edit user success:', response);
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công',
                    text: 'Thông tin người dùng đã được cập nhật!',
                    confirmButtonColor: '#4e73df'
                }).then(() => {
                    location.reload();
                });
            },
            error: function(xhr, status, error) {
                console.error('Edit user error:', {xhr, status, error});
                let errorMessage = 'Không thể cập nhật thông tin.';
                
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.message || response.error || errorMessage;
                    console.error('Error response:', response);
                } catch (e) {
                    console.error('Error parsing response:', e);
                    if (xhr.responseText && xhr.responseText.length < 200) {
                        errorMessage = xhr.responseText;
                    }
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: errorMessage,
                    confirmButtonColor: '#4e73df'
                });
            }
        });
    });
    
    // Xử lý form reset mật khẩu
    $('#resetPasswordForm').on('submit', function(e) {
        e.preventDefault();
        
        var newPassword = $('#id_new_password').val();
        var confirmPassword = $('#id_confirm_password').val();
        
        if (newPassword !== confirmPassword) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Mật khẩu xác nhận không khớp!',
                confirmButtonColor: '#4e73df',
                confirmButtonText: 'Đóng'
            });
            return;
        }
        
        Swal.fire({
            title: 'Xác nhận đặt lại mật khẩu?',
            text: 'Mật khẩu của người dùng sẽ được thay đổi',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f6c23e',
            cancelButtonColor: '#858796',
            confirmButtonText: 'Đồng ý',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Đang xử lý...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
        
                $.ajax({
                    url: '{% url "dashboard:user_reset_password" user.id %}',
                    method: 'POST',
                    data: {
                        'new_password': newPassword,
                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        console.log('Success:', response);
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công',
                            text: 'Mật khẩu đã được đặt lại thành công!',
                            confirmButtonColor: '#4e73df',
                            confirmButtonText: 'Đóng'
                        });
                        $('#id_new_password').val('');
                        $('#id_confirm_password').val('');
                    },
                    error: function(error) {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: 'Không thể đặt lại mật khẩu. Vui lòng thử lại sau.',
                            confirmButtonColor: '#4e73df',
                            confirmButtonText: 'Đóng'
                        });
                    }
                });
            }
        });
    });
    
    // Kích hoạt các nút điều chỉnh loại trong form số dư và TCoin
    $('.form-check-label').on('click', function() {
        const inputId = $(this).attr('for');
        $('#' + inputId).prop('checked', true).trigger('change');
        
        // Cập nhật trạng thái active cho label
        $(this).closest('.adjust-type-container').find('.form-check-label').removeClass('active');
        $(this).addClass('active');
    });

    // Xử lý nút cập nhật số dư
    $('#adjustBalanceBtn').click(function() {
        const form = $('#balanceForm');
        const csrfToken = form.find('input[name="csrfmiddlewaretoken"]').val();
        const adjustType = form.find('input[name="adjustType"]:checked').val();
        const amountInput = form.find('input[name="amount"]');
        const amountStr = amountInput.val().replace(/[^\d]/g, '');
        const amount = parseInt(amountStr, 10);
        const reason = form.find('textarea[name="reason"]').val().trim() || "Admin cập nhật";
        
        if (isNaN(amount) || amount === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Thông báo',
                text: 'Vui lòng nhập số tiền hợp lệ',
                confirmButtonColor: '#4e73df'
            });
            return;
        }

        // Tính toán số tiền điều chỉnh
        let adjustAmount;
        const currentBalance = {{ user.balance|default:'0' }};
        
        if (adjustType === 'set') {
            adjustAmount = amount - currentBalance;
        } else if (adjustType === 'subtract') {
            adjustAmount = -amount;
        } else {
            adjustAmount = amount;
        }

        // Debug dữ liệu gửi đi
        console.log('Balance adjustment data:', {
            amount: adjustAmount,
            reason: reason,
            adjustType: adjustType,
            currentBalance: currentBalance,
            newBalance: currentBalance + adjustAmount
        });

        // Hiển thị xác nhận
        Swal.fire({
            title: 'Xác nhận điều chỉnh số dư',
            html: `Bạn muốn ${adjustType === 'add' ? 'cộng' : adjustType === 'subtract' ? 'trừ' : 'đặt'} 
                  <b>${amount.toLocaleString('vi-VN')}đ</b> ${adjustType !== 'set' ? 'vào số dư' : 'làm số dư mới'}?<br>
                  Số dư hiện tại: <b>${currentBalance.toLocaleString('vi-VN')}đ</b><br>
                  Số dư sau điều chỉnh: <b>${(currentBalance + adjustAmount).toLocaleString('vi-VN')}đ</b>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#4e73df',
            cancelButtonColor: '#858796',
            confirmButtonText: 'Xác nhận',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                // Gửi request
                $.ajax({
                    url: '{% url "dashboard:adjust_balance" user.id %}',
                    method: 'POST',
                    data: {
                        amount: adjustAmount,
                        reason: reason,
                        csrfmiddlewaretoken: csrfToken
                    },
                    beforeSend: function() {
                        Swal.fire({
                            title: 'Đang xử lý...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                    },
                    success: function(response) {
                        console.log('Balance adjustment response:', response);
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công',
                            text: 'Số dư đã được cập nhật thành công!',
                            confirmButtonColor: '#4e73df'
                        }).then(() => {
                            location.reload();
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Balance adjustment error:', {
                            xhr: xhr,
                            status: status,
                            error: error,
                            responseText: xhr.responseText
                        });
                        
                        let errorMessage = 'Không thể cập nhật số dư.';
                        
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMessage = response.message || response.error || errorMessage;
                        } catch (e) {
                            console.error('Error parsing response:', e);
                            if (xhr.responseText && xhr.responseText.length < 200) {
                                errorMessage = xhr.responseText;
                            }
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: errorMessage,
                            confirmButtonColor: '#4e73df'
                        });
                    }
                });
            }
        });
    });

    // Xử lý nút cập nhật TCoin
    $('#adjustTCoinBtn').click(function() {
        const form = $('#tcoinForm');
        const csrfToken = form.find('input[name="csrfmiddlewaretoken"]').val();
        const adjustType = form.find('input[name="tcoinAdjustType"]:checked').val();
        const amountInput = form.find('input[name="amount"]');
        const amountStr = amountInput.val().replace(/[^\d]/g, '');
        const amount = parseInt(amountStr, 10);
        const reason = form.find('textarea[name="reason"]').val().trim() || "Admin cập nhật";
        
        if (isNaN(amount) || amount === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Thông báo',
                text: 'Vui lòng nhập số lượng TCoin hợp lệ',
                confirmButtonColor: '#4e73df'
            });
            return;
        }

        // Tính toán số TCoin điều chỉnh
        let adjustAmount;
        const currentTCoin = {{ user.tcoin_balance|default:'0' }};
        
        if (adjustType === 'set') {
            // Nếu là "Đặt số TCoin", gửi giá trị mới trực tiếp
            adjustAmount = amount - currentTCoin;
        } else if (adjustType === 'subtract') {
            adjustAmount = -amount;
        } else {
            adjustAmount = amount;
        }

        // Debug dữ liệu gửi đi
        console.log('TCoin adjustment data:', {
            amount: adjustAmount,
            reason: reason,
            adjustType: adjustType,
            currentTCoin: currentTCoin,
            newTCoin: currentTCoin + adjustAmount
        });

        // Hiển thị xác nhận
        Swal.fire({
            title: 'Xác nhận điều chỉnh TCoin',
            html: `Bạn muốn ${adjustType === 'add' ? 'cộng' : adjustType === 'subtract' ? 'trừ' : 'đặt'} 
                  <b>${amount.toLocaleString('vi-VN')} TCoin</b> ${adjustType !== 'set' ? 'vào tài khoản' : 'làm số TCoin mới'}?<br>
                  TCoin hiện tại: <b>${currentTCoin.toLocaleString('vi-VN')}</b><br>
                  TCoin sau điều chỉnh: <b>${(currentTCoin + adjustAmount).toLocaleString('vi-VN')}</b>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#f6c23e',
            cancelButtonColor: '#858796',
            confirmButtonText: 'Xác nhận',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                // Gửi request
                $.ajax({
                    url: '{% url "dashboard:adjust_tcoin" user.id %}',
                    method: 'POST',
                    data: {
                        amount: adjustAmount,
                        reason: reason,
                        csrfmiddlewaretoken: csrfToken
                    },
                    beforeSend: function() {
                        Swal.fire({
                            title: 'Đang xử lý...',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                    },
                    success: function(response) {
                        console.log('TCoin adjustment response:', response);
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công',
                            text: 'TCoin đã được cập nhật thành công!',
                            confirmButtonColor: '#4e73df'
                        }).then(() => {
                            location.reload();
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('TCoin adjustment error:', {
                            xhr: xhr,
                            status: status,
                            error: error,
                            responseText: xhr.responseText
                        });
                        
                        // Kiểm tra nếu lỗi là do created_by
                        if (xhr.responseText && xhr.responseText.includes('created_by')) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công',
                                text: 'TCoin đã được cập nhật thành công!',
                                confirmButtonColor: '#4e73df'
                            }).then(() => {
                                location.reload();
                            });
                            return;
                        }
                        
                        let errorMessage = 'Không thể cập nhật TCoin.';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMessage = response.message || response.error || errorMessage;
                        } catch (e) {
                            console.error('Error parsing response:', e);
                            if (xhr.responseText && xhr.responseText.length < 200) {
                                errorMessage = xhr.responseText;
                            }
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: errorMessage,
                            confirmButtonColor: '#4e73df'
                        });
                    }
                });
            }
        });
    });

    // Xử lý ảnh avatar không tồn tại
    $('img.user-avatar').on('error', function() {
        // Thay thế bằng div chứa chữ cái đầu của username
        var username = '{{ user.username }}';
        var initial = username ? username.charAt(0).toUpperCase() : '?';
        
        $(this).replaceWith('<div class="avatar-placeholder">' + initial + '</div>');
    });

    // Thêm hàm format số tiền
    function formatCurrency(input) {
        // Xóa tất cả ký tự không phải số
        let value = input.value.replace(/[^\d]/g, '');
        
        // Lưu giá trị số nguyên vào data attribute của element
        input.setAttribute('data-value', value);
        
        // Format hiển thị với dấu phẩy
        if (value) {
            value = Number(value).toLocaleString('vi-VN');
        }
        
        // Cập nhật giá trị hiển thị
        input.value = value;
    }

    // Áp dụng cho input số tiền
    $('input[name="amount"]').on('input', function() {
        formatCurrency(this);
    });
    
    // Thêm xử lý cho nút tạo mật khẩu xác thực
    $('#generatePassword').on('click', function() {
        const randomPassword = Math.random().toString(36).slice(-8);
        $('#id_2fa_password').val(randomPassword);
        
        Swal.fire({
            icon: 'success',
            title: 'Đã tạo mật khẩu xác thực',
            text: 'Mật khẩu mới: ' + randomPassword,
            confirmButtonColor: '#4e73df'
        });
    });
    
    // Thêm xử lý cho nút tạo mã bí mật Google Authenticator
    $('#generateGAKey').on('click', function() {
        // Tạo một mã bí mật ngẫu nhiên 16 ký tự
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
        let gaKey = '';
        for (let i = 0; i < 16; i++) {
            gaKey += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        
        $('#id_ga_secret_key').val(gaKey);
        
        // Cập nhật QR code nếu đã tồn tại
        const qrUrl = 'https://chart.googleapis.com/chart?chs=200x200&chld=M|0&cht=qr&chl=otpauth://totp/' + 
                      encodeURIComponent('{{ user.email }}') + '?secret=' + gaKey + '&issuer=TomOi';
        
        // Kiểm tra nếu hình ảnh QR đã tồn tại
        if ($('#gaQrCode').length) {
            $('#gaQrCode').attr('src', qrUrl);
        } else {
            // Nếu chưa có, thêm mới
            const qrHtml = `
                <div class="text-center mb-3">
                    <img id="gaQrCode" src="${qrUrl}" class="img-fluid border rounded" alt="QR Code">
                    <p class="small text-muted mt-2">Quét mã QR với ứng dụng Google Authenticator</p>
                </div>
            `;
            $('#google2faOptions').append(qrHtml);
        }
        
        Swal.fire({
            icon: 'success',
            title: 'Đã tạo mã bí mật mới',
            text: 'Mã bí mật mới đã được tạo: ' + gaKey,
            confirmButtonColor: '#4e73df'
        });
    });

    // Khi trang tải xong, kích hoạt các nút đã chọn để CSS được áp dụng đúng
    let checkedBalanceType = $('input[name="adjustType"]:checked').attr('id');
    $('label[for="' + checkedBalanceType + '"]').addClass('active');
    
    let checkedTCoinType = $('input[name="tcoinAdjustType"]:checked').attr('id');
    $('label[for="' + checkedTCoinType + '"]').addClass('active');
    
    // Xử lý hiển thị các tùy chọn 2FA
    $('#id_two_factor_method').on('change', function() {
        const selectedMethod = $(this).val();
        
        // Ẩn tất cả các tùy chọn
        $('.password-2fa-options').removeClass('show');
        
        // Hiển thị tùy chọn tương ứng
        if (selectedMethod === 'password') {
            $('#password2faOptions').addClass('show');
        } else if (selectedMethod === 'email') {
            $('#email2faOptions').addClass('show');
        } else if (selectedMethod === 'google') {
            $('#google2faOptions').addClass('show');
        }
        
        // Cập nhật trạng thái has_2fa
        if (selectedMethod) {
            $('#id_has_2fa').prop('checked', true);
        }
    });

    // Xử lý khi checkbox has_2fa thay đổi
    $('#id_has_2fa').on('change', function() {
        const isChecked = $(this).is(':checked');
        if (!isChecked) {
            // Nếu bỏ chọn has_2fa, reset two_factor_method về rỗng
            $('#id_two_factor_method').val('').trigger('change');
        }
    });

    // Xử lý tạo mật khẩu 2FA ngẫu nhiên
    $('#generatePassword').on('click', function() {
        const randomPassword = generateRandomPassword(8);
        $('#id_2fa_password').val(randomPassword);
    });

    // Xử lý tạo mã GA ngẫu nhiên
    $('#generateGAKey').on('click', function() {
        const randomKey = generateRandomKey(16);
        $('#id_ga_secret_key').val(randomKey);
    });

    // Hàm tạo mật khẩu ngẫu nhiên
    function generateRandomPassword(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    // Hàm tạo khóa GA ngẫu nhiên
    function generateRandomKey(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    // Xử lý khi click vào icon upload avatar
    $('.avatar-upload').click(function() {
        $('#avatar-input').click();
    });
    
    // Xử lý khi chọn file avatar mới
    $('#avatar-input').change(function() {
        if (this.files && this.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('.user-avatar').attr('src', e.target.result);
            }
            reader.readAsDataURL(this.files[0]);
            
            // Tự động upload avatar khi chọn file
            var formData = new FormData();
            formData.append('avatar', this.files[0]);
            formData.append('csrfmiddlewaretoken', $('input[name="csrfmiddlewaretoken"]').val());
            
            $.ajax({
                url: '{% url "dashboard:user_edit" user.id %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log('Avatar upload success:', response);
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công',
                        text: 'Avatar đã được cập nhật!',
                        confirmButtonColor: '#4e73df'
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Avatar upload error:', {xhr, status, error});
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Không thể cập nhật avatar. Vui lòng thử lại!',
                        confirmButtonColor: '#4e73df'
                    });
                }
            });
        }
    });

    // Trigger để hiển thị đúng tùy chọn 2FA khi trang load
    $('#id_two_factor_method').trigger('change');
});
</script>
{% endblock %} 