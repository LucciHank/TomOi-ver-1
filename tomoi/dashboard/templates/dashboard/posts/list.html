{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Quản lý tin tức{% endblock %}

{% block page_title %}Quản lý tin tức{% endblock %}
{% block page_subtitle %}Quản lý bài viết và tin tức{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row">
    <div class="col-sm-6 col-md-3">
        <div class="card border-0 shadow">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <span class="h6 font-semibold text-muted text-sm d-block mb-2">Tổng bài viết</span>
                        <span class="h3 font-bold mb-0">{{ total_posts }}</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-primary text-white text-lg rounded-circle">
                            <i class="fas fa-newspaper"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-sm-6 col-md-3">
        <div class="card border-0 shadow">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <span class="h6 font-semibold text-muted text-sm d-block mb-2">Bài nổi bật</span>
                        <span class="h3 font-bold mb-0">{{ featured_posts }}</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-warning text-white text-lg rounded-circle">
                            <i class="fas fa-star"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-md-3">
        <div class="card border-0 shadow">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <span class="h6 font-semibold text-muted text-sm d-block mb-2">Lượt xem</span>
                        <span class="h3 font-bold mb-0">{{ total_views }}</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-info text-white text-lg rounded-circle">
                            <i class="fas fa-eye"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-md-3">
        <div class="card border-0 shadow">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <span class="h6 font-semibold text-muted text-sm d-block mb-2">Danh mục</span>
                        <span class="h3 font-bold mb-0">{{ total_categories }}</span>
                    </div>
                    <div class="col-auto">
                        <div class="icon icon-shape bg-success text-white text-lg rounded-circle">
                            <i class="fas fa-folder"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card border-0 shadow mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4 mb-3 mb-md-0">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm bài viết...">
                </div>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
                <select class="form-select" id="filterCategory">
                    <option value="">Tất cả danh mục</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
                <select class="form-select" id="filterStatus">
                    <option value="">Tất cả trạng thái</option>
                    <option value="published">Đã xuất bản</option>
                    <option value="draft">Bản nháp</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addPostModal">
                    <i class="fas fa-plus me-2"></i>Thêm mới
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Posts List -->
<div class="card border-0 shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-centered table-nowrap mb-0 rounded">
                <thead class="thead-light">
                    <tr>
                        <th class="border-0 rounded-start">Tiêu đề</th>
                        <th class="border-0">Danh mục</th>
                        <th class="border-0">Tác giả</th>
                        <th class="border-0">Ngày đăng</th>
                        <th class="border-0">Lượt xem</th>
                        <th class="border-0">Trạng thái</th>
                        <th class="border-0 rounded-end">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for post in posts %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if post.thumbnail %}
                                <img src="{{ post.thumbnail.url }}" class="avatar rounded-circle me-3" alt="">
                                {% endif %}
                                <div>
                                    <a href="{% url 'dashboard:edit_post' post.id %}" class="text-primary fw-bold">
                                        {{ post.title }}
                                    </a>
                                    {% if post.is_featured %}
                                    <span class="badge bg-warning ms-2">Nổi bật</span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>{{ post.category.name }}</td>
                        <td>{{ post.author.get_full_name }}</td>
                        <td>{{ post.published_at|date:"d/m/Y H:i" }}</td>
                        <td>{{ post.views }}</td>
                        <td>
                            {% if post.status == 'published' %}
                            <span class="badge bg-success">Đã xuất bản</span>
                            {% else %}
                            <span class="badge bg-secondary">Bản nháp</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-link text-dark dropdown-toggle dropdown-toggle-split m-0 p-0" 
                                        data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="dropdown-menu py-0">
                                    <a class="dropdown-item" href="{% url 'dashboard:edit_post' post.id %}">
                                        <i class="fas fa-edit me-2"></i>Chỉnh sửa
                                    </a>
                                    <a class="dropdown-item text-warning" href="#" 
                                       onclick="toggleFeatured({{ post.id }})">
                                        <i class="fas fa-star me-2"></i>
                                        {% if post.is_featured %}Bỏ nổi bật{% else %}Đánh dấu nổi bật{% endif %}
                                    </a>
                                    <a class="dropdown-item text-danger" href="#" 
                                       onclick="deletePost({{ post.id }})">
                                        <i class="fas fa-trash-alt me-2"></i>Xóa
                                    </a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-newspaper text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted mb-0">Chưa có bài viết nào</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if posts.has_other_pages %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center mb-0">
                {% if posts.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ posts.previous_page_number }}">
                        <i class="fas fa-angle-left"></i>
                    </a>
                </li>
                {% endif %}

                {% for i in posts.paginator.page_range %}
                <li class="page-item {% if posts.number == i %}active{% endif %}">
                    <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                </li>
                {% endfor %}

                {% if posts.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ posts.next_page_number }}">
                        <i class="fas fa-angle-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

{% include 'dashboard/posts/modals/post_form.html' %}
{% endblock %}

{% block extra_js %}
<script>
// Xử lý tìm kiếm
$('#searchInput').on('keyup', function() {
    var searchTerm = $(this).val().toLowerCase();
    $('tbody tr').each(function() {
        var title = $(this).find('td:first').text().toLowerCase();
        $(this).toggle(title.indexOf(searchTerm) > -1);
    });
});

// Xử lý filter danh mục
$('#filterCategory').on('change', function() {
    var categoryId = $(this).val();
    filterPosts();
});

// Xử lý filter trạng thái
$('#filterStatus').on('change', function() {
    filterPosts();
});

function filterPosts() {
    var categoryId = $('#filterCategory').val();
    var status = $('#filterStatus').val();
    
    $('tbody tr').each(function() {
        var categoryMatch = !categoryId || $(this).find('td:eq(1)').data('category-id') == categoryId;
        var statusMatch = !status || $(this).find('td:eq(5)').text().toLowerCase().includes(status);
        $(this).toggle(categoryMatch && statusMatch);
    });
}

// Xử lý toggle featured
function toggleFeatured(postId) {
    $.post('{% url "dashboard:toggle_featured" %}', {
        post_id: postId,
        csrfmiddlewaretoken: '{{ csrf_token }}'
    }).done(function(response) {
        if (response.success) {
            location.reload();
        }
    });
}

// Xử lý xóa bài viết
function deletePost(postId) {
    Swal.fire({
        title: 'Xác nhận xóa',
        text: "Bạn có chắc muốn xóa bài viết này?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Xóa',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            $.post('{% url "dashboard:delete_post" %}', {
                post_id: postId,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }).done(function(response) {
                if (response.success) {
                    location.reload();
                }
            });
        }
    });
}
</script>
{% endblock %} 